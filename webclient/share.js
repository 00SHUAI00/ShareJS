/*
 ShareJS v0.3.0
 http://sharejs.org

 Copyright 2011 ShareJS Authors

 BSD licensed:
 https://github.com/josephg/ShareJS/raw/master/LICENSE
*/
var g=void 0,q=null;
(function(){function k(b,a){return function(){return b.apply(a,arguments)}}var t,v,m,l,A,E,r,s,j,F,G,B,C,w,x,f,D,y,u,H=Array.prototype.slice;j={version:"0.3.0"};C=typeof!0!=="undefined"?function(b){return setTimeout(b,0)}:C=process.nextTick;m=function(){function b(){}b.prototype.f=function(a,c){var b;this.b||(this.b={});(b=this.b)[a]||(b[a]=[]);this.b[a].push(c);return this};b.prototype.m=function(a,c){var b,e;this.b||(this.b={});e=(b=this.b)[a]||(b[a]=[]);for(b=0;b<e.length;)e[b]===c&&(e[b]=g),b++;
C(k(function(){var b;return this.b[a]=function(){var c,d,e,h;e=this.b[a];h=[];for(c=0,d=e.length;c<d;c++)(b=e[c])&&h.push(b);return h}.call(this)},this));return this};b.prototype.a=function(){var a,b,d,e,i;b=arguments[0];a=2<=arguments.length?H.call(arguments,1):[];if(!((d=this.b)!=q&&d[b]))return this;i=this.b[b];for(d=0,e=i.length;d<e;d++)(b=i[d])&&b.apply(this,a);return this};return b}();m.q=function(b){b=b.prototype||b;b.f=b.on=m.prototype.f;b.m=b.removeListener=m.prototype.m;b.a=b.emit=m.prototype.a};
if(typeof module!=="undefined"&&module!==q&&module.n)module.n=m;j._bt=A=function(b,a,c,d){var e,i;e=function(b,c,d,e){a(d,b,c,"left");a(e,c,b,"right")};b.H=b.transformX=i=function(a,b){var n,h,f,k,o,z,p,j,l,m;c(a);c(b);k=[];for(z=0,j=b.length;z<j;z++){h=b[z];f=[];for(n=0;n<a.length;)if(o=[],e(a[n],h,f,o),n++,o.length===1)h=o[0];else{if(o.length===0){p=a.slice(n);for(o=0,h=p.length;o<h;o++)n=p[o],d(f,n)}else{m=i(a.slice(n),o);h=m[0];o=m[1];for(p=0,l=h.length;p<l;p++)n=h[p],d(f,n);for(h=0,p=o.length;h<
p;h++)n=o[h],d(k,n)}h=q;break}h!=q&&d(k,h);a=f}return[a,k]};return b.transform=b.transform=function(b,c,d){var e,f;if(!(d==="left"||d==="right"))throw Error("type must be 'left' or 'right'");if(c.length===0)return b;return b.length===1&&c.length===1?a([],b[0],c[0],d):d==="left"?(f=i(b,c),e=f[0],e):(e=i(c,b),f=e[1],f)}};if(typeof!0==="undefined")j.t=A;f={name:"text"};f.create=f.create=function(){return""};x=function(b,a,c){return b.slice(0,a)+c+b.slice(a)};E=function(b){if(typeof b.p!=="number")throw Error("component missing position field");
if(!(typeof b.i==="string"^typeof b.d==="string"))throw Error("component needs an i or d field");if(!(b.p>=0))throw Error("position cannot be negative");};r=function(b){var a,c,d;for(c=0,d=b.length;c<d;c++)a=b[c],E(a);return!0};f.apply=function(b,a){var c,d,e,i;r(a);for(e=0,i=a.length;e<i;e++)if(c=a[e],c.i!=q)b=x(b,c.p,c.i);else{d=b.slice(c.p,c.p+c.d.length);if(c.d!==d)throw Error("Delete component '"+c.d+"' does not match deleted text '"+d+"'");b=b.slice(0,c.p)+b.slice(c.p+c.d.length)}return b};
f.B=l=function(b,a){var c,d,e;if(!(a.i===""||a.d===""))return b.length===0?b.push(a):(c=b[b.length-1],c.i!=q&&a.i!=q&&c.p<=(d=a.p)&&d<=c.p+c.i.length?b[b.length-1]={i:x(c.i,a.p-c.p,a.i),p:c.p}:c.d!=q&&a.d!=q&&a.p<=(e=c.p)&&e<=a.p+a.d.length?b[b.length-1]={d:x(a.d,c.p-a.p,c.d),p:a.p}:b.push(a))};f.compose=f.u=function(b,a){var c,d,e,i;r(b);r(a);d=b.slice();for(e=0,i=a.length;e<i;e++)c=a[e],l(d,c);return d};f.compress=f.C=function(b){return f.u([],b)};f.normalize=function(b){var a,c,d,e;c=[];if(b.i!=
q||b.p!=q)b=[b];for(d=0,e=b.length;d<e;d++)a=b[d],a.p==q&&(a.p=0),l(c,a);return c};y=function(b,a,c){return a.i!=q?a.p<b||a.p===b&&c?b+a.i.length:b:b<=a.p?b:b<=a.p+a.d.length?a.p:b-a.d.length};f.transformCursor=function(b,a,c){var d,e,i;for(e=0,i=a.length;e<i;e++)d=a[e],b=y(b,d,c);return b};f._tc=D=function(b,a,c,d){var e,i;r([a]);r([c]);if(a.i!=q)l(b,{i:a.i,p:y(a.p,c,d==="right")});else if(c.i!=q)d=a.d,a.p<c.p&&(l(b,{d:d.slice(0,c.p-a.p),p:a.p}),d=d.slice(c.p-a.p)),d!==""&&l(b,{d:d,p:a.p+c.i.length});
else if(a.p>=c.p+c.d.length)l(b,{d:a.d,p:a.p-c.d.length});else if(a.p+a.d.length<=c.p)l(b,a);else{d={d:"",p:a.p};a.p<c.p&&(d.d=a.d.slice(0,c.p-a.p));a.p+a.d.length>c.p+c.d.length&&(d.d+=a.d.slice(c.p+c.d.length-a.p));i=Math.max(a.p,c.p);e=Math.min(a.p+a.d.length,c.p+c.d.length);a=a.d.slice(i-a.p,e-a.p);e=c.d.slice(i-c.p,e-c.p);if(a!==e)throw Error("Delete ops delete different text in the same region of the document");if(d.d!=="")d.p=y(d.p,c),l(b,d)}return b};G=function(b){return b.i!=q?{d:b.i,p:b.p}:
{i:b.d,p:b.p}};f.F=f.invert=function(b){var a,c,d,e;d=b.slice().reverse();e=[];for(a=0,c=d.length;a<c;a++)b=d[a],e.push(G(b));return e};typeof!0!=="undefined"?(j.types||(j.types={}),A(f,D,r,l),j.types.text=f):(module.n=f,require("./helpers").t(f,D,r,l));typeof!0==="undefined"&&(f=require("./text"));f.api={provides:{text:!0},getLength:function(){return this.g.length},getText:function(){return this.g},insert:function(b,a,c){a==q&&(a=0);b=[{p:a,i:b}];this.r(b,c);return b},del:function(b,a,c){b=[{p:a,
d:this.g.slice(a,a+b)}];this.r(b,c);return b},_register:function(){return this.f("remoteop",function(b){var a,c,d,e;e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(a.i!==g?this.a("insert",a.i,a.p):this.a("delete",a.d,a.p));return e})}};if(typeof!0!=="undefined"){u||(u=j.types);if(!window.io)throw Error("Must load socket.io before this library");B=window.io}else u=require("../types"),B=require("socket.io-client"),m=require("./microevent");v=function(b,a,c,d,e){var i,f,j,n,h,l,m;this.name=a;this.version=
c;this.type=d;if(this.type.compose==q)throw Error("Handling types without compose() defined is not currently implemented");l=k(function(a){return this.snapshot=this.g=a},this);l(e);f=q;i=[];h=q;n=[];m=k(function(){if(f===q&&h!==q)return f=h,i=n,h=q,n=[],b.send({doc:this.name,op:f,v:this.version},k(function(a){var b,c,e;if(a.v===q){if(d.invert)b=this.type.invert(f),h&&(b=this.type.transform(b,h,"left")),l(this.type.apply(this.g,b));else throw Error("Op apply failed ("+a.error+") and the OT type does not define an invert function.");
for(c=0,e=i.length;c<e;c++)b=i[c],b(q,a.error)}else{if(a.v!==this.version)throw Error("Invalid version from server");this.version++;for(a=0,c=i.length;a<c;a++)b=i[a],b(f,q)}f=q;return m()},this))},this);this.s=function(a){var b,c,d;if(!(a.v<this.version)){if(a.doc!==this.name)throw Error("Expected docName "+this.name+" but got "+a.doc);if(a.v!==this.version)throw Error("Expected version "+this.version+" but got "+a.v);a=a.op;c=this.type.transformX||k(function(a,b){var c,d;c=this.type.transform(a,
b,"left");d=this.type.transform(b,a,"right");return[c,d]},this);f!==q&&(b=c(f,a),f=b[0],a=b[1]);h!==q&&(d=c(h,a),h=d[0],a=d[1]);b=this.g;l(this.type.apply(b,a));this.version++;this.a("remoteop",a,b);return this.a("change",a,b)}};this.submitOp=this.r=function(a,b){this.type.normalize!=q&&(a=this.type.normalize(a));l(this.type.apply(this.g,a));h=h!==q?this.type.compose(h,a):a;b&&n.push(b);this.a("change",a);return setTimeout(m,0)};this.close=this.close=function(a){return b.send({doc:this.name,open:!1},
k(function(){a&&a();this.a("closed")},this))};if(this.type.api){c=this.type.api;for(j in c)a=c[j],this[j]=a;typeof this._register==="function"&&this._register()}else this.G=this.provides={};return this};m.q(v);t=function(){function b(a){this.l=k(this.l,this);this.h=k(this.h,this);this.k=k(this.k,this);this.e=B.connect(a,{"force new connection":!0});this.e.on("connect",this.h);this.e.on("disconnect",this.k);this.e.on("message",this.l);this.e.socket.connected&&setTimeout(k(function(){return this.h()},
this),0);this.c={};this.j=0}b.prototype.k=function(){return this.a("disconnect")};b.prototype.h=function(){return this.a("connect")};b.prototype.send=function(a,b){var d,e,f;d=a.doc;d===this.z?delete a.doc:this.z=d;this.e.json.send(a);if(b)return e=k(function(a){var e;e=k(function(f){if(f.doc===d)return this.m(a,e),b(f)},this);return this.f(a,e)},this),f=a.open===!0?"open":a.open===!1?"close":a.create?"create":a.snapshot===q?"snapshot":a.op?"op response":g,e(f)};b.prototype.l=function(a){var b,d;
b=a.doc;b!==g?this.w=b:a.doc=b=this.w;this.a("message",a);d=a.open===!0||a.open===!1&&a.error?"open":a.open===!1?"close":a.snapshot!==g?"snapshot":a.create?"create":a.op?"op":a.v!==g?"op response":g;this.a(d,a);if(d==="op"&&(b=this.c[b]))return b.s(a)};b.prototype.o=function(a){var b,d;d=a.doc;if(this.c[d])throw Error("Doc "+d+" already open");b=a.type;typeof b==="string"&&(b=u[b]);b=new v(this,d,a.v,b,a.snapshot);b.created=!!a.create;this.c[d]=b;this.j++;b.f("closed",k(function(){delete this.c[d];
return this.j--},this));return b};b.prototype.openExisting=function(a,b){return this.c[a]!=q?this.c[a]:this.send({doc:a,open:!0,snapshot:q},k(function(a){return a.error?b(q,Error(a.error)):b(this.o(a))},this))};b.prototype.open=function(a,b,d){typeof b==="function"&&(d=b,b="text");d||(d=function(){});typeof b==="string"&&(b=u[b]);if(a!=q&&this.c[a]!=q)a=this.c[a],a.type===b?d(a):d(a,"Type mismatch");else return this.send({doc:a,open:!0,create:!0,snapshot:q,type:b.name},k(function(a){return a.error?
d(q,a.error):(a.snapshot===g&&(a.snapshot=b.create()),a.type=b,d(this.o(a)))},this))};b.prototype.create=function(a,b){return w(q,a,b)};b.prototype.disconnect=function(){if(this.e)return this.a("disconnected"),this.e.disconnect(),this.e=q};return b}();m.q(t);s={};F=function(b){var a;if(typeof!0!=="undefined")a=window.location,b==q&&(b=""+a.protocol+"//"+a.hostname+"/sjs");s[b]||(a=new t(b),a.f("disconnected",function(){return delete s[b]}),s[b]=a);return s[b]};w=function(b,a,c,d){var e;typeof c===
"function"&&(d=c,c=q);e=F(c);return e.open(b,a,function(a,b){return a===q?(e.j===0&&e.disconnect(),d(q,b)):(a.f("closed",function(){return setTimeout(function(){if(e.j===0)return e.disconnect()},0)}),d(a))})};j.D=function(){return console.log(s)};typeof!0!=="undefined"?(j.Connection=t,j.Doc=v,j.open=w,window.sharejs=j):(j.A=t,j.open=w)}).call(this);