/*
 ShareJS v0.1.1
 http://sharejs.org

 Copyright 2011 Joseph Gentle

 BSD licensed:
 https://github.com/josephg/ShareJS/raw/master/LICENSE
*/
function f(h){throw h;}var n=void 0,r=null;
(function(){function h(b,a){return function(){return b.apply(a,arguments)}}var u,p,q,j,z,s,A,t,i,B,C,D,y,v,l,w,x,E=Array.prototype.slice;i={};q=function(){function b(){}b.prototype.g=function(a,c){var b;this.c||(this.c={});(b=this.c)[a]||(b[a]=[]);this.c[a].push(c);return this};b.prototype.s=function(a,c){var b,e;this.c||(this.c={});b=(e=this.c[a])!=r?e.indexOf(c):n;b!=r&&b>=0&&this.c[a].splice(b,1);return this};b.prototype.a=function(){var a,c,b,e,g;c=arguments[0];a=2<=arguments.length?E.call(arguments,
1):[];if(!((b=this.c)!=r&&b[c]))return this;g=this.c[c];b=0;for(e=g.length;b<e;b++)c=g[b],c.apply(this,a);return this};return b}();q.B=function(b){b=b.prototype||b;b.g=b.on=q.prototype.g;b.s=b.removeListener=q.prototype.s;b.a=q.prototype.a};if(typeof module!=="undefined"&&module!==r&&module.G)module.G=q;l={name:"text",M:function(){return""}};v=function(b,a,c){return b.slice(0,a)+c+b.slice(a)};z=function(b){typeof b.p!=="number"&&f(Error("component missing position field"));typeof b.i==="string"^typeof b.d===
"string"||f(Error("component needs an i or d field"));b.p>=0||f(Error("position cannot be negative"))};s=function(b){var a,c,d;c=0;for(d=b.length;c<d;c++)a=b[c],z(a);return!0};l.apply=function(b,a){var c,d,e,g;s(a);e=0;for(g=a.length;e<g;e++)c=a[e],c.i!=r?b=v(b,c.p,c.i):(d=b.slice(c.p,c.p+c.d.length),c.d!==d&&f(Error("Delete component '"+c.d+"' does not match deleted text '"+d+"'")),b=b.slice(0,c.p)+b.slice(c.p+c.d.length));return b};l.J=j=function(b,a){var c,d,e;if(!(a.i===""||a.d===""))return b.length===
0?b.push(a):(c=b[b.length-1],c.i!=r&&a.i!=r&&c.p<=(d=a.p)&&d<=c.p+c.i.length?b[b.length-1]={i:v(c.i,a.p-c.p,a.i),p:c.p}:c.d!=r&&a.d!=r&&a.p<=(e=c.p)&&e<=a.p+a.d.length?b[b.length-1]={d:v(a.d,c.p-a.p,c.d),p:a.p}:b.push(a))};l.t=A=function(b,a){var c,d,e,g;s(b);s(a);d=b.slice();e=0;for(g=a.length;e<g;e++)c=a[e],j(d,c);return d};l.L=function(b){return A([],b)};l.normalize=function(b){var a,c,d,e;c=[];if(b.i!=r||b.p!=r)b=[b];d=0;for(e=b.length;d<e;d++)a=b[d],a.p==r&&(a.p=0),j(c,a);return c};w=function(b,
a,c){return a.i!=r?a.p<b||a.p===b&&c?b+a.i.length:b:b<=a.p?b:b<=a.p+a.d.length?a.p:b-a.d.length};l.transformCursor=function(b,a,c){var d,e,g;e=0;for(g=a.length;e<g;e++)d=a[e],b=w(b,d,c);return b};C=function(b){return b.i!=r?{d:b.i,p:b.p}:{i:b.d,p:b.p}};l.N=function(b){var a,c,d,e;d=b.slice().reverse();e=[];a=0;for(c=d.length;a<c;a++)b=d[a],e.push(C(b));return e};i.types||(i.types={});(function(b,a,c,d){var e,g;e=function(c,b,d,e){a(d,c,b,"server");a(e,b,c,"client")};b.I=g=function(a,b){var o,k,h,
j,m,l,i,p,q;c(a);c(b);h=[];l=0;for(p=b.length;l<p;l++){k=b[l];j=[];for(o=0;o<a.length;)if(m=[],e(a[o],k,j,m),o++,m.length===1)k=m[0];else{if(m.length===0){i=a.slice(o);k=0;for(m=i.length;k<m;k++)o=i[k],d(j,o)}else{k=g(a.slice(o),m);m=k[0];k=k[1];i=0;for(q=m.length;i<q;i++)o=m[i],d(j,o);m=0;for(i=k.length;m<i;m++)o=k[m],d(h,o)}k=r;break}k!=r&&d(h,k);a=j}return[a,h]};return b.transform=function(c,b,d){d==="server"||d==="client"||f(Error("type must be 'server' or 'client'"));if(b.length===0)return c;
if(c.length===1&&b.length===1)return a([],c[0],b[0],d);d==="server"?(c=g(c,b),c=c[0]):(c=g(b,c),c=c[1]);return c}})(l,function(b,a,c,d){var e,g;s([a]);s([c]);if(a.i!=r)j(b,{i:a.i,p:w(a.p,c,d==="server")});else if(c.i!=r)d=a.d,a.p<c.p&&(j(b,{d:d.slice(0,c.p-a.p),p:a.p}),d=d.slice(c.p-a.p)),d!==""&&j(b,{d:d,p:a.p+c.i.length});else if(a.p>=c.p+c.d.length)j(b,{d:a.d,p:a.p-c.d.length});else if(a.p+a.d.length<=c.p)j(b,a);else if(d={d:"",p:a.p},a.p<c.p&&(d.d=a.d.slice(0,c.p-a.p)),a.p+a.d.length>c.p+c.d.length&&
(d.d+=a.d.slice(c.p+c.d.length-a.p)),g=Math.max(a.p,c.p),e=Math.min(a.p+a.d.length,c.p+c.d.length),a=a.d.slice(g-a.p,e-a.p),e=c.d.slice(g-c.p,e-c.p),a!==e&&f(Error("Delete ops delete different text in the same region of the document")),d.d!=="")d.p=w(d.p,c),j(b,d);return b},s,j);i.types.text=l;x||(x=i.types);window.io||f(Error("Must load socket.io before this library"));D=window.io;p=function(){function b(a,c,b,e,g){this.u=a;this.name=c;this.version=b;this.type=e;this.q=h(this.q,this);this.j=h(this.j,
this);this.type.t==r&&f(Error("Handling types without compose() defined is not currently implemented"));this.snapshot=g;this.b=r;this.m=[];this.e=r;this.r=[];this.C={};this.O=[]}b.prototype.j=function(){if(this.b===r&&this.e!==r)return this.b=this.e,this.m=this.r,this.e=r,this.r=[],this.u.send({doc:this.name,op:this.b,v:this.version},h(function(a){var c,b,e,g;if(a.v===r){g=this.m;b=0;for(e=g.length;b<e;b++)c=g[b],c(r);this.b=r;f(Error(a.error))}a.v!==this.version&&f(Error("Invalid version from server"));
this.C[this.version]=this.b;this.version++;e=this.m;a=0;for(b=e.length;a<b;a++)c=e[a],c(this.b,r);this.b=r;return this.j()},this))};b.prototype.q=function(a){var c,b;if(!(a.v<this.version)){a.doc!==this.name&&f(Error("Expected docName "+this.name+" but got "+a.doc));a.v!==this.version&&f(Error("Expected version "+this.version+" but got "+a.v));a=a.op;this.C[this.version]=a;c=this.type.I||h(function(a,c){var b,d;d=this.type.transform(a,c,"server");b=this.type.transform(c,a,"client");return[d,b]},this);
if(this.b!==r)b=c(a,this.b),a=b[0],this.b=b[1];if(this.e!==r)c=c(a,this.e),a=c[0],this.e=c[1];this.snapshot=this.type.apply(this.snapshot,a);this.version++;this.a("remoteop",a);return this.a("change",a)}};b.prototype.H=function(a,c,b){var e;if(c==r)c=this.version;if(typeof c==="function")b=c,c=this.version;if(((e=this.type)!=r?e.normalize:n)!=r)a=this.type.normalize(a);for(;c<this.version;)(e=this.P[c])||f(Error("Op version too old")),a=this.type.transform(a,e,"client"),c++;this.snapshot=this.type.apply(this.snapshot,
a);this.e=this.e!==r?this.type.t(this.e,a):a;b&&this.r.push(b);this.a("change",a);return setTimeout(this.j,0)};b.prototype.close=function(a){return this.u.send({doc:this.name,open:!1},h(function(){a&&a();this.a("closed")},this))};return b}();q.B(p);p.prototype.submitOp=p.prototype.H;p.prototype.close=p.prototype.close;u=function(){function b(a,c,b){this.o=h(this.o,this);this.k=h(this.k,this);this.l=h(this.l,this);this.h=new D.Socket(a,{port:c,Q:b?path+"/socket.io":"socket.io"});this.h.on("connect",
this.k);this.h.on("disconnect",this.l);this.h.on("message",this.o);this.h.connect();this.z=this.w=r;this.f={};this.n=0}b.prototype.l=function(){return this.a("disconnect")};b.prototype.k=function(){return this.a("connect")};b.prototype.send=function(a,c){var b,e;b=a.doc;b===this.z?delete a.doc:this.z=b;this.h.send(a);if(c)return e=h(function(a){var e;e=h(function(h){if(h.doc===b)return this.s(a,e),c(h)},this);return this.g(a,e)},this),e(a.open===!0?"open":a.open===!1?"close":a.create?"create":a.snapshot===
r?"snapshot":a.op?"op response":n)};b.prototype.o=function(a){var c,b;c=a.doc;c!==n?this.w=c:a.doc=c=this.w;this.a("message",a);b=a.open===!0||a.open===!1&&a.error?"open":a.open===!1?"close":a.snapshot!==n?"snapshot":a.create?"create":a.op?"op":a.v!==n?"op response":n;this.a(b,a);if(b==="op"&&(c=this.f[c]))return c.q(a)};b.prototype.A=function(a){var b,d;d=a.doc;this.f[d]&&f(Error("Document "+d+" already followed"));b=a.type;typeof b==="string"&&(b=x[b]);b=new p(this,d,a.v,b,a.snapshot);b.created=
!!a.create;this.f[d]=b;this.n++;b.g("closed",h(function(){delete this.f[d];return this.n--},this));return b};b.prototype.openExisting=function(a,b){if(this.f[a]!=r)return this.f[a];return this.send({doc:a,open:!0,snapshot:r},h(function(a){return a.error?b(r,Error(a.error)):b(this.A(a))},this))};b.prototype.open=function(a,b,d){typeof b==="function"&&(d=b,b="text");d||(d=function(){});typeof b==="string"&&(b=x[b]);if(this.f[a]!=r)a=this.f[a],a.type===b?d(a):d(a,"Type mismatch");else return this.send({doc:a,
open:!0,create:!0,snapshot:r,type:b.name},h(function(a){return a.error?d(r,Error(a.error)):(a.snapshot===n&&(a.snapshot=""),a.type=b,d(this.A(a)))},this))};b.prototype.create=function(a,b){return y(r,a,b)};b.prototype.disconnect=function(){if(this.D!=r)return this.a("disconnected"),this.D.F(),this.D=r};return b}();q.B(u);t={};B=function(b,a,c){var d;if(b==r)b=window.location.hostname;if(a==r)a=window.location.port;d=b;a!=r&&(d+=":"+a);t[d]||(b=new u(b,a,c),b.g("disconnected",function(){return delete t[d]}),
t[d]=b);return t[d]};y=function(b,a,c,d){var e;typeof c==="function"&&(d=c,c=r);c==r&&(c={});e=B(c.host,c.port,c.K);return e.open(b,a,function(a){a.g("closed",function(){return setTimeout(function(){if(e.n===0)return e.F()},0)});return d(a)})};i.Connection=u;i.Document=p;i.open=y;window.sharejs=i}).call(this);