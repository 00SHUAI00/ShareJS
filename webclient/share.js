(function(){(function(){var t,e,n,o,r,i,s={exports:{}},c=s.exports;c.name="text",c.uri="http://sharejs.org/types/textv1",c.create=function(t){if(null!=t&&"string"!=typeof t)throw Error("Initial data must be a string");return t||""},t=function(t){var e,n,o,r;if(!Array.isArray(t))throw Error("Op must be an array of components");for(n=null,o=0,r=t.length;r>o;o++){switch(e=t[o],typeof e){case"object":if(!("number"==typeof e.d&&e.d>0))throw Error("Object components must be deletes of size > 0");break;case"string":if(!(e.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(e>0))throw Error("Skip components must be >0");if("number"==typeof n)throw Error("Adjacent skip components should be combined")}n=e}if("number"==typeof n)throw Error("Op has a trailing skip")},n=function(t){return function(e){return e&&0!==e.d?0===t.length?t.push(e):typeof e==typeof t[t.length-1]?"object"==typeof e?t[t.length-1].d+=e.d:t[t.length-1]+=e:t.push(e):void 0}},o=function(t){var e,n,o,r;return e=0,n=0,r=function(o,r){var i,s;return e===t.length?-1===o?null:o:(i=t[e],"number"==typeof i?-1===o||o>=i-n?(s=i-n,++e,n=0,s):(n+=o,o):"string"==typeof i?-1===o||"i"===r||o>=i.length-n?(s=i.slice(n),++e,n=0,s):(s=i.slice(n,n+o),n+=o,s):-1===o||"d"===r||o>=i.d-n?(s={d:i.d-n},++e,n=0,s):(n+=o,{d:o}))},o=function(){return t[e]},[r,o]},e=function(t){return"number"==typeof t?t:t.length||t.d},i=function(t){return t.length>0&&"number"==typeof t[t.length-1]&&t.pop(),t},c.normalize=function(t){var e,o,r,s,c;for(r=[],e=n(r),s=0,c=t.length;c>s;s++)o=t[s],e(o);return i(r)},c.apply=function(e,n){var o,r,i,s,c;if("string"!=typeof e)throw Error("Snapshot should be a string");for(t(n),i=0,r=[],s=0,c=n.length;c>s;s++)switch(o=n[s],typeof o){case"number":if(o>e.length)throw Error("The op is too long for this document");r.push(e.slice(0,o)),e=e.slice(o);break;case"string":r.push(o);break;case"object":e=e.slice(o.d)}return r.join("")+e},c.transform=function(r,s,c){var a,u,h,l,p,f,d,v,y,b,m;if("left"!==c&&"right"!==c)throw Error("side ("+c+") must be 'left' or 'right'");for(t(r),t(s),p=[],a=n(p),m=o(r),v=m[0],d=m[1],y=0,b=s.length;b>y;y++)switch(h=s[y],typeof h){case"number":for(l=h;l>0;)u=v(l,"i"),a(u),"string"!=typeof u&&(l-=e(u));break;case"string":"left"===c&&(f=d(),"string"==typeof f&&a(v(-1))),a(h.length);break;case"object":for(l=h.d;l>0;)switch(u=v(l,"i"),typeof u){case"number":l-=u;break;case"string":a(u);break;case"object":l-=u.d}}for(;h=v(-1);)a(h);return i(p)},c.compose=function(r,s){var c,a,u,h,l,p,f,d,v,y;for(t(r),t(s),l=[],c=n(l),y=o(r),p=y[0],f=y[1],d=0,v=s.length;v>d;d++)switch(u=s[d],typeof u){case"number":for(h=u;h>0;)a=p(h,"d"),c(a),"object"!=typeof a&&(h-=e(a));break;case"string":c(u);break;case"object":for(h=u.d;h>0;)switch(a=p(h,"d"),typeof a){case"number":c({d:a}),h-=a;break;case"string":h-=a.length;break;case"object":c(a)}}for(;u=p(-1);)c(u);return i(l)},r=function(t,e){var n,o,r,i;for(o=0,r=0,i=e.length;i>r&&(n=e[r],!(o>=t));r++)switch(typeof n){case"number":if(o+n>=t)return t;o+=n;break;case"string":o+=n.length,t+=n.length;break;case"object":t-=Math.min(n.d,t-o)}return t},c.transformCursor=function(t,e,n){var o,i,s,c;if(i=0,n){for(s=0,c=e.length;c>s;s++)switch(o=e[s],typeof o){case"number":i+=o;break;case"string":i+=o.length}return[i,i]}return[r(t[0],e),r(t[1],e)]};var a=window.ottypes=window.ottypes||{},u=s.exports;a[u.name]=u,u.uri&&(a[u.uri]=u)})();var t;window.sharejs=t={version:"0.7.0"};var e,n,o=[].slice;n=function(t){return setTimeout(t,0)},e=function(){function t(){}return t.prototype.on=function(t,e){var n;return this._events||(this._events={}),(n=this._events)[t]||(n[t]=[]),this._events[t].push(e),this},t.prototype.removeListener=function(t,e){var o,r,i,s=this;for(this._events||(this._events={}),r=(i=this._events)[t]||(i[t]=[]),o=0;r.length>o;)r[o]===e&&(r[o]=void 0),o++;return n(function(){var e;return s._events[t]=function(){var n,o,r,i;for(r=this._events[t],i=[],n=0,o=r.length;o>n;n++)e=r[n],e&&i.push(e);return i}.call(s)}),this},t.prototype.emit=function(){var t,e,n,r,i,s,c;if(e=arguments[0],t=arguments.length>=2?o.call(arguments,1):[],!(null!=(s=this._events)?s[e]:void 0))return"error"===e&&"undefined"!=typeof console&&null!==console&&console.error.apply(console,t),this;for(c=this._events[e],r=0,i=c.length;i>r;r++)n=c[r],n&&n.apply(this,t);return this},t.prototype.once=function(t,e){var n,r=this;return this.on(t,n=function(){var i;return i=arguments.length>=1?o.call(arguments,0):[],r.removeListener(t,n),e.apply(r,i)})},t}(),e.mixin=function(t){var n;return n=t.prototype||t,n.on=e.prototype.on,n.removeListener=e.prototype.removeListener,n.emit=e.prototype.emit,n.once=e.prototype.once,t};var r,e,i;t.extendDoc=function(t,e){return r.prototype[t]=e},r=function(){function t(t,e,n,o){this.connection=t,this.collection=e,this.name=n,this.subscribed=!1,this.subscribeRequested=!1,this.inflightData=null,this.pendingData=[],o&&this._injestData(o)}var e;return t.prototype._send=function(t){return t.c=this.collection,t.doc=this.name,this.connection.send(t)},t.prototype.subscribe=function(t){var e,n=this;return this.subscribeRequested?"function"==typeof t?t("Already subscribed"):void 0:(this.subscribeRequested=!0,t&&(this._subscribeCallback=function(e){return n._subscribeCallback=null,t(e)}),"disconnected"!==this.connection.state?(e={a:"sub"},"number"==typeof this.version&&(e.v=this.version),this._send(e)):void 0)},t.prototype.unsubscribe=function(t){var e=this;if(this.subscribeRequested&&(this.subscribeRequested=!1,"disconnected"!==this.connection.state))return t&&(this._unsubscribeCallback=function(n){return e._unsubscribeCallback=null,t(n)}),this._send({a:"unsub"})},t.prototype.fetch=function(t){return t&&this.once("fetched",t),this._send({a:"fetch"})},t.prototype._connectionStateChanged=function(t,e){switch(t){case"disconnected":this.subscribed=!1;break;case"connecting":this.subscribeRequested&&(this.subscribeRequested=!1,this.subscribe()),this.inflightData&&this._sendOpData(this.inflightData)}return this.emit(t,e)},t.prototype._setType=function(t){var e,n,o,r;if("string"==typeof t){if(!i[t])throw Error("Missing type "+t);t=i[t]}if(t&&!t.compose)throw Error("Support for types without compose() is not implemented");if(null!=(o=this.type)?o.api:void 0){this._onOp&&this.removeListener("op",this._onOp);for(e in this.type.api)delete this[e]}if(this.type=t,this.type||(this.snapshot=null),null!=t?!t.api:true)return this.provides={};r=t.api;for(e in r)n=r[e],this[e]=n;return this._onOp?this.on("op",this._onOp):void 0},t.prototype._injestData=function(t){if("number"!=typeof t.v)throw Error("Missing version");return"number"==typeof this.version?("undefined"!=typeof console&&null!==console&&console.warn("Ignoring extra attempt to injest data"),void 0):(this.version=t.v,this.snapshot=t.snapshot,this._setType(t.type))},e=function(t){return delete t.op,delete t.create,delete t.del},t.prototype._xf=function(t,n){var o;if(n.create||n.del)return e(t);if(t.del)return e(n);if(t.create)throw Error("Invalid state. This is a bug. Please file an issue on github");if(n.op&&t.op)return t.type.transformX?(o=t.type.transformX(t.op,n.op),t.op=o[0],n.op=o[1],o):(t.op=this.type.transform(t.op,n.op,"left"),n.op=this.type.transform(n.op,t.op,"right"))},t.prototype._otApply=function(t,e){var n,o,r=this;if(this.locked=!0,n=t.create)return this._setType(n.type),this.snapshot=this.type.create(n.data),setTimeout(function(){return r.emit("ready",e)},0),setTimeout(function(){return r.emit("created",e)},0);if(t.del)return this._setType(null),setTimeout(function(){return r.emit("deleted",e)},0);if(o=t.op){if(!this.type)throw Error("Document does not exist");return o=t.op,this.emit("before op",o,e),this.incremental&&this.type.incrementalApply?this.type.incrementalApply(this.snapshot,o,function(t,n){return r.snapshot=n,r.emit("op",t,e)}):(this.snapshot=this.type.apply(this.snapshot,o),this.emit("op",o,e))}return"undefined"!=typeof console&&null!==console?console.warn("Ignoring received no-op.",t):void 0},t.prototype._afterOtApply=function(t,e){return this.locked=!1,t.op?this.emit("after op",t.op,e):void 0},t.prototype._tryRollback=function(t){var e,n,o,r,i;if(t.create)return this._setType(null);if(t.op&&t.type.invert){for(n=t.type.invert(t.op),i=this.pendingData,o=0,r=i.length;r>o;o++)e=i[o],this._xf(e,n);return this._otApply(n,!1),this._afterOtApply(n,!1)}return this.emit("error","Op apply failed and the operation could not be reverted"),this._setType(null),this.v=null,this.fetch()},t.prototype._opAcknowledged=function(t){var e,n,o,r,i,s;if("Op already submitted"!==o){if(e=this.inflightData,this.inflightData=null,o=t.error)this._tryRollback(e);else{if(t.v!==this.version)throw Error("Invalid version from server. Please file an issue, this is a bug.");this.version++,this.emit("acknowledge",e)}for(s=e.callbacks,r=0,i=s.length;i>r;r++)n=s[r],n(o);return this.flush()}},t.prototype._onMessage=function(t){var e,n,o,r,i,s,c,a;if(t.c!==this.collection||t.doc!==this.name)throw Error("Got message for wrong document. Expected '"+this.collection+"'.'"+this.name+"' but got '"+t.c+"'.'"+t.doc+"'");switch(t.a){case"data":return this._injestData(t),this.type&&this.emit("ready"),this.emit("fetched");case"sub":if(t.error){"undefined"!=typeof console&&null!==console&&console.error("Could not open document: "+t.error),this.emit("error",t.error),this.subscribed=!1,this.subscribeRequested=!1,"function"==typeof this._subscribeCallback&&this._subscribeCallback(t.error);break}return this.subscribed=!0,this.emit("subscribed"),"function"==typeof this._subscribeCallback&&this._subscribeCallback(),this.flush();case"unsub":return this.subscribed=!1,this.emit("unsubscribed"),"function"==typeof this._unsubscribeCallback?this._unsubscribeCallback():void 0;case"ack":if(t.error)return this._opAcknowledged(t);break;case"op":if(this.inflightData&&t.src===this.inflightData.src&&t.seq===this.inflightData.seq){this._opAcknowledged(t);break}if(t.v!==this.version)return this.emit("error","Expected version "+this.version+" but got "+t.v);for(e=t,this.inflightData&&this._xf(this.inflightData,e),c=this.pendingData,i=0,s=c.length;s>i;i++)o=c[i],this._xf(o,e);return this.version++,this._otApply(e,!1),this._afterOtApply(e,!1);case"meta":return a=t.meta,n=a.path,r=a.value,"undefined"!=typeof console&&null!==console?console.warn("Unhandled meta op:",t):void 0;default:return"undefined"!=typeof console&&null!==console?console.warn("Unhandled document message:",t):void 0}},t.prototype._submitOpData=function(t,e){var n,o,r=this;return o=function(t){return e?e(t):"undefined"!=typeof console&&null!==console?console.warn("Failed attempt to submitOp:",t):void 0},this.subscribeRequested?this.locked?o("Cannot call submitOp from inside an 'op' event handler"):(t.op&&(this.type||o("Document has not been created"),null!=this.type.normalize&&(t.op=this.type.normalize(t.op))),this._otApply(t,!0),t.op&&this.pendingData.length&&(n=this.pendingData[this.pendingData.length-1]).op?n.op=this.type.compose(n.op,t.op):(n=t,t.type=this.type,t.callbacks=[],this.pendingData.push(t)),e&&n.callbacks.push(e),this._afterOtApply(t,!0),setTimeout(function(){return r.flush()},0)):o("You cannot currently submit operations to an unsubscribed document")},t.prototype.submitOp=function(t,e){return this._submitOpData({op:t},e)},t.prototype.create=function(t,e,n){var o;return"function"==typeof e&&(o=[void 0,e],e=o[0],n=o[1]),this.type?"function"==typeof n?n("Document already exists"):void 0:this._submitOpData({create:{type:t,data:e}},n)},t.prototype.del=function(t){return this.type?this._submitOpData({del:!0},t):"function"==typeof t?t("Document does not exist"):void 0},t.prototype._sendOpData=function(t){var e;return e={a:"op",v:this.version},t.src&&(e.src=t.src,e.seq=t.seq),t.op&&(e.op=t.op),t.create&&(e.create=t.create),t.del&&(e.del=t.del),this._send(e),t.src?void 0:(t.src=this.connection.id,t.seq=this.connection.seq++)},t.prototype.flush=function(){var t;if(("connecting"===(t=this.connection.state)||"connected"===t)&&null===this.inflightData&&this.pendingData.length)return this.inflightData=this.pendingData.shift(),this._sendOpData(this.inflightData)},t.prototype.getSnapshot=function(){return this.snapshot},t}(),e.mixin(r),t.Doc=r;var s,r,e,i;i=ottypes,s=function(){function t(t){var e=this;this.socket=t,this.collections={},this.nextQueryId=1,this.queries={},this.state="disconnected",this.socket.onmessage=function(t){var n,o,r;switch(console.log("RECV",t),t.a){case"init":if(0!==t.protocol)throw Error("Invalid protocol version");if("string"!=typeof t.id)throw Error("Invalid client id");return e.id=t.id,e.setState("connected");case"q":return e.queries[t.id].onmessage(t);default:return void 0!==t.doc?(n=e.lastReceivedCollection=t.c,r=e.lastReceivedDoc=t.doc):(n=t.c=e.lastReceivedCollection,r=t.doc=e.lastReceivedDoc),(o=e.get(n,r))?o._onMessage(t):"undefined"!=typeof console&&null!==console?console.error("Unhandled message",t):void 0}},this.connected=!1,this.socket.onclose=function(t){return e.setState("disconnected",t),"Closed"===t||"Stopped by server"===t?e.setState("stopped",e.lastError||t):void 0},this.socket.onerror=function(t){return e.emit("error",t)},this.socket.onopen=function(){return e.setState("connecting")},this.reset()}return t.prototype._error=function(t){return this.setState("stopped",t),this.disconnect(t)},t.prototype.reset=function(){return this.id=this.lastError=this.lastReceivedDoc=this.lastSentDoc=null,this.seq=1},t.prototype.setState=function(t,e){var n,o,r,i,s,c;if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state||"connected"===t&&"connecting"!==this.state)throw Error("Cannot transition directly from "+this.state+" to "+t);this.state=t,"disconnected"===t&&this.reset(),this.emit(t,e),s=this.collections,c=[];for(n in s)o=s[n],c.push(function(){var n;n=[];for(i in o)r=o[i],n.push(r._connectionStateChanged(t,e));return n}());return c}},t.prototype.send=function(t){var e,n;return console.log("SEND:",t),t.doc&&(n=t.doc,e=t.c,e===this.lastSentCollection&&n===this.lastSentDoc?(delete t.c,delete t.doc):(this.lastSentCollection=e,this.lastSentDoc=n)),this.socket.send(t)},t.prototype.disconnect=function(){return this.socket.close()},t.prototype.get=function(t,e){var n;return null!=(n=this.collections[t])?n[e]:void 0},t.prototype.getOrCreate=function(t,e,n){var o,i;return(o=this.get(t,e))?o:(o=new r(this,t,e,n),t=(i=this.collections)[t]||(i[t]={}),t[e]=o)},t.prototype.query=function(t,n,o){var r,i;return r=this.nextQueryId++,this.queries[r]=i={state:"loading",onmessage:function(t){return"loading"===this.state&&(t.error?(this.state="error",this.emit("error",t.error),this.emit("loaded",t.error)):(this.state="ok",this.data=t.data,this.emit("loaded",t,t.data))),t.add?console.log("add",t.add):t.remove?console.log("remove",t.rm):void 0}},e.mixin(i),i.once("loaded",o),this.send({a:"q",id:r,q:n}),i},t}(),e.mixin(s),t.Connection=s;var s,c;c=void 0!==window.BCSocket,t.open=function(){var t,e,n;return t={},e=function(e,n){var o,r,i;return null==e&&(i=window.location,e=""+i.protocol+"//"+i.host+"/channel"),t[e]||(o=new s(new BCSocket(e,{reconnect:!0}),n),r=function(){return delete t[e]},o.on("disconnected",r),o.on("connect failed",r),t[e]=o),t[e]},n=function(t){var e,n,o,r;o=0,r=t.docs;for(n in r)e=r[n],("closed"!==e.state||e.autoOpen)&&o++;return 0===o?t.disconnect():void 0},function(t,o,r,i,s){var a,u,h;if(!c)throw Error("Cannot find browserchannel. If you want to use a custom channel, create a connection manually.");return"function"==typeof i&&(s=i,i={}),"string"==typeof i&&(i={origin:i}),h=i.origin,a=i.authentication,u=e(h,a),u.open(t,o,r,function(t,e){return t?(s(t),n(u)):(e.on("closed",function(){return n(u)}),s(null,e))}),u.on("connect failed"),u}}();var a;a=function(t,e,n){var o,r;if(e!==n){for(r=0;e.charAt(r)===n.charAt(r);)r++;for(o=0;e.charAt(e.length-1-o)===n.charAt(n.length-1-o)&&e.length>o+r&&n.length>o+r;)o++;return e.length!==r+o&&t.remove(r,e.length-r-o),n.length!==r+o?t.insert(r,n.slice(r,n.length-o)):void 0}},window.sharejs.extendDoc("attach_textarea",function(t){var e,n,o,r,i,s,c;return o=this,c=function(e,n){var o,r;return o=[n(t.selectionStart),n(t.selectionEnd)],r=t.scrollTop,t.value=e,t.scrollTop!==r&&(t.scrollTop=r),window.document.activeElement===t?(t.selectionStart=o[0],t.selectionEnd=o[1],o):void 0},i=function(e,n){var o,r;return r=function(t){return t>e?t+n.length:t},o=t.value.replace(/\r\n/g,"\n"),c(o.slice(0,e)+n+o.slice(e),r)},s=function(e,n){var o,r;return r=function(t){return t>e?t-Math.min(n,t-e):t},o=t.value.replace(/\r\n/g,"\n"),c(o.slice(0,e)+o.slice(e+n),r)},r=function(){var e;return e=function(t){return setTimeout(t,0)},e(function(){var e;return t.value!==e?(e=t.value,a(o,o.getText(),t.value.replace(/\r\n/g,"\n"))):void 0})},e=function(){var e,c,a,u,h;if(!o.provides.text)return"undefined"!=typeof console&&null!==console?console.warn("Could not attach document: text api incompatible"):void 0;for(c=t.value=o.getText(),o.on("insert",i),o.on("remove",s),h=["textInput","keydown","keyup","select","cut","paste"],a=0,u=h.length;u>a;a++)e=h[a],t.addEventListener?t.addEventListener(e,r,!1):t.attachEvent("on"+e,r);return o.once("deleted",n)},n=t.detach_share=function(){var n,c,a,u;for(o.removeListener("insert",i),o.removeListener("remove",s),u=["textInput","keydown","keyup","select","cut","paste"],c=0,a=u.length;a>c;c++)n=u[c],t.removeEventListener?t.removeEventListener(n,r,!1):t.detachEvent("on"+n,r);return t.disabled=!0,o.once("ready",e)},o.type?e():o.once("ready",e)});var u;u=ottypes.text,u.api={provides:{text:!0},getLength:function(){return this.getSnapshot().length},getText:function(){return this.getSnapshot()},insert:function(t,e,n){var o;return o=u.normalize([t,e]),this.submitOp(o,n),o},remove:function(t,e,n){var o;return o=u.normalize([t,{d:e}]),this.submitOp(o,n),o},_onOp:function(t,e){var n,o,r,i,s,c;if(!e){for(o=r=0,c=[],i=0,s=t.length;s>i;i++)switch(n=t[i],typeof n){case"number":o+=n,c.push(r+=n);break;case"string":this.emit("insert",o,n),c.push(o+=n.length);break;case"object":this.emit("remove",o,n.d),c.push(r+=n.d);break;default:c.push(void 0)}return c}}}})();