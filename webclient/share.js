/*
 ShareJS v0.2.0
 http://sharejs.org

 Copyright 2011 ShareJS Authors

 BSD licensed:
 https://github.com/josephg/ShareJS/raw/master/LICENSE
*/
function g(l){throw l;}var h=void 0,m=null;
(function(){function l(c,a){return function(){return c.apply(a,arguments)}}var y,t,v,s,C,F,w,p,G,x,n,H,I,J,D,E,z,q,K,A,B,L=Array.prototype.slice;n={};v=function(){function c(){}c.prototype.g=function(a,b){var c;this.c||(this.c={});(c=this.c)[a]||(c[a]=[]);this.c[a].push(b);return this};c.prototype.u=function(a,b){var c,d;this.c||(this.c={});c=(d=this.c[a])!=m?d.indexOf(b):h;c!=m&&c>=0&&this.c[a].splice(c,1);return this};c.prototype.a=function(){var a,b,c,d,e;b=arguments[0];a=2<=arguments.length?L.call(arguments,
1):[];if(!((c=this.c)!=m&&c[b]))return this;e=this.c[b];c=0;for(d=e.length;c<d;c++)b=e[c],b.apply(this,a);return this};return c}();v.G=function(c){c=c.prototype||c;c.g=c.on=v.prototype.g;c.u=c.removeListener=v.prototype.u;c.a=v.prototype.a};if(typeof module!=="undefined"&&module!==m&&module.M)module.M=v;C=function(c,a,b,f){var d,e;d=function(b,c,f,d){a(f,b,c,"server");a(d,c,b,"client")};c.S=e=function(a,c){var j,o,l,p,r,n,u,q,s;b(a);b(c);l=[];n=0;for(q=c.length;n<q;n++){o=c[n];p=[];for(j=0;j<a.length;)if(r=
[],d(a[j],o,p,r),j++,r.length===1)o=r[0];else{if(r.length===0){u=a.slice(j);o=0;for(r=u.length;o<r;o++)j=u[o],f(p,j)}else{o=e(a.slice(j),r);r=o[0];o=o[1];u=0;for(s=r.length;u<s;u++)j=r[u],f(p,j);r=0;for(u=o.length;r<u;r++)j=o[r],f(l,j)}o=m;break}o!=m&&f(l,o);a=p}return[a,l]};c.transform=function(b,c,f){f==="server"||f==="client"||g(Error("type must be 'server' or 'client'"));if(c.length===0)return b;if(b.length===1&&c.length===1)return a([],b[0],c[0],f);f==="server"?(b=e(b,c),b=b[0]):(b=e(c,b),b=
b[1]);return b}};q={name:"text",B:function(){return""}};z=function(c,a,b){return c.slice(0,a)+b+c.slice(a)};F=function(c){typeof c.p!=="number"&&g(Error("component missing position field"));typeof c.i==="string"^typeof c.d==="string"||g(Error("component needs an i or d field"));c.p>=0||g(Error("position cannot be negative"))};w=function(c){var a,b,f;b=0;for(f=c.length;b<f;b++)a=c[b],F(a);return!0};q.apply=function(c,a){var b,f,d,e;w(a);d=0;for(e=a.length;d<e;d++)b=a[d],b.i!=m?c=z(c,b.p,b.i):(f=c.slice(b.p,
b.p+b.d.length),b.d!==f&&g(Error("Delete component '"+b.d+"' does not match deleted text '"+f+"'")),c=c.slice(0,b.p)+c.slice(b.p+b.d.length));return c};q.T=s=function(c,a){var b,f,d;if(!(a.i===""||a.d===""))return c.length===0?c.push(a):(b=c[c.length-1],b.i!=m&&a.i!=m&&b.p<=(f=a.p)&&f<=b.p+b.i.length?c[c.length-1]={i:z(b.i,a.p-b.p,a.i),p:b.p}:b.d!=m&&a.d!=m&&a.p<=(d=b.p)&&d<=a.p+a.d.length?c[c.length-1]={d:z(a.d,b.p-a.p,b.d),p:a.p}:c.push(a))};q.l=G=function(c,a){var b,f,d,e;w(c);w(a);f=c.slice();
d=0;for(e=a.length;d<e;d++)b=a[d],s(f,b);return f};q.V=function(c){return G([],c)};q.normalize=function(c){var a,b,f,d;b=[];if(c.i!=m||c.p!=m)c=[c];f=0;for(d=c.length;f<d;f++)a=c[f],a.p==m&&(a.p=0),s(b,a);return b};A=function(c,a,b){return a.i!=m?a.p<c||a.p===c&&b?c+a.i.length:c:c<=a.p?c:c<=a.p+a.d.length?a.p:c-a.d.length};q.transformCursor=function(c,a,b){var f,d,e;d=0;for(e=a.length;d<e;d++)f=a[d],c=A(c,f,b);return c};q.J=K=function(c,a,b,f){var d,e;w([a]);w([b]);if(a.i!=m)s(c,{i:a.i,p:A(a.p,b,
f==="server")});else if(b.i!=m)f=a.d,a.p<b.p&&(s(c,{d:f.slice(0,b.p-a.p),p:a.p}),f=f.slice(b.p-a.p)),f!==""&&s(c,{d:f,p:a.p+b.i.length});else if(a.p>=b.p+b.d.length)s(c,{d:a.d,p:a.p-b.d.length});else if(a.p+a.d.length<=b.p)s(c,a);else if(f={d:"",p:a.p},a.p<b.p&&(f.d=a.d.slice(0,b.p-a.p)),a.p+a.d.length>b.p+b.d.length&&(f.d+=a.d.slice(b.p+b.d.length-a.p)),e=Math.max(a.p,b.p),d=Math.min(a.p+a.d.length,b.p+b.d.length),a=a.d.slice(e-a.p,d-a.p),d=b.d.slice(e-b.p,d-b.p),a!==d&&g(Error("Delete ops delete different text in the same region of the document")),
f.d!=="")f.p=A(f.p,b),s(c,f);return c};I=function(c){return c.i!=m?{d:c.i,p:c.p}:{i:c.d,p:c.p}};q.N=function(c){var a,b,f,d;f=c.slice().reverse();d=[];a=0;for(b=f.length;a<b;a++)c=f[a],d.push(I(c));return d};n.types||(n.types={});C(q,K,w,s);n.types.text=q;typeof json!=="undefined"&&json!==m||(json={});json.name="json";json.B=function(){return m};json.O=function(c){var a;a={p:c.p};c.si!==h&&(a.sd=c.si);c.sd!==h&&(a.si=c.sd);c.oi!==h&&(a.od=c.oi);c.od!==h&&(a.oi=c.od);c.li!==h&&(a.ld=c.li);c.ld!==h&&
(a.li=c.ld);c.na!==h&&(a.na=-c.na);if(c.lm!==h)a.lm=c.p[c.p.length-1],a.p=c.p.slice(0,c.p.length-1).concat([c.lm]);return a};json.N=function(c){var a,b,f,d;f=c.slice().reverse();d=[];a=0;for(b=f.length;a<b;a++)c=f[a],d.push(json.O(c));return d};json.K=function(){};D=function(c){return Object.prototype.toString.call(c)==="[object Array]"};json.j=function(c){D(c)||g(Error("Referenced element not a list"))};json.w=function(c){c.constructor!==Object&&g(Error("Referenced element not an object (it was "+
JSON.stringify(c)+")"))};json.apply=function(c,a){var b,f,d,e,k,i,j,o,l,n,r,q,s,a=p(a);f={data:p(c)};try{k=0;for(r=a.length;k<r;k++){b=a[k];l=o=m;e=f;i="data";s=b.p;n=0;for(q=s.length;n<q;n++)j=s[n],o=e,l=i,e=e[i],i=j,o==m&&g(Error("Path invalid"));b.na!==h?(typeof e[i]!=="number"&&g(Error("Referenced element not a number")),e[i]+=b.na):b.si!==h?(typeof e!=="string"&&g(Error("Referenced element not a string (it was "+JSON.stringify(e)+")")),o[l]=e.slice(0,i)+b.si+e.slice(i)):b.sd!==h?(typeof e!==
"string"&&g(Error("Referenced element not a string")),e.slice(i,i+b.sd.length)!==b.sd&&g(Error("Deleted string does not match")),o[l]=e.slice(0,i)+e.slice(i+b.sd.length)):b.li!==h&&b.ld!==h?(json.j(e),e[i]=b.li):b.li!==h?(json.j(e),e.splice(i,0,b.li)):b.ld!==h?(json.j(e),e.splice(i,1)):b.lm!==h?(json.j(e),b.lm!==i&&(d=e[i],e.splice(i,1),e.splice(b.lm,0,d))):b.oi!==h?(json.w(e),e[i]=b.oi):b.od!==h&&(json.w(e),delete e[i])}}catch(t){g(t)}return f.data};json.P=function(c,a){var b,f,d;if(c.length!==a.length)return!1;
b=0;for(d=c.length;b<d;b++)if(f=c[b],f!==a[b])return!1;return!0};json.append=function(c,a){var b,a=p(a);return c.length!==0&&json.P(a.p,(b=c[c.length-1]).p)?b.na!==h&&a.na!==h?c[c.length-1]={p:b.p,na:b.na+a.na}:b.li!==h&&a.li===h&&a.ld===b.li?b.ld!==h?delete b.li:c.pop():b.od!==h&&b.oi===h&&a.oi!==h&&a.od===h?b.oi=a.oi:a.lm!==h&&a.p[a.p.length-1]===a.lm?m:c.push(a):c.push(a)};json.l=function(c,a){var b,f,d,e;f=p(c);d=0;for(e=a.length;d<e;d++)b=a[d],json.append(f,b);return f};json.normalize=function(c){var a,
b,f,d;b=[];D(c)||(c=[c]);f=0;for(d=c.length;f<d;f++)a=c[f],a.p==m&&(a.p=[]),json.append(b,a);return b};p=function(c){return JSON.parse(JSON.stringify(c))};json.z=function(c,a){var b,c=c.slice(),a=a.slice();c.unshift("data");a.unshift("data");c=c.slice(0,c.length-1);a=a.slice(0,a.length-1);if(a.length===0)return-1;for(b=0;c[b]===a[b]&&b<c.length;)if(b++,b===a.length)return b-1};json.R=function(c,a,b,f){var d,e,k,i,j,a=p(a);a.na!==h&&a.p.push(0);b.na!==h&&b.p.push(0);d=json.z(a.p,b.p);e=json.z(b.p,
a.p);k=a.p.length;i=b.p.length;a.na!==h&&a.p.pop();b.na!==h&&b.p.pop();if(b.na){if(e!=m&&i>=k&&b.p[e]===a.p[e])if(a.ld!==h)e=p(b),e.p=e.p.slice(k),a.ld=json.apply(p(a.ld),[e]);else if(a.od!==h)e=p(b),e.p=e.p.slice(k),a.od=json.apply(p(a.od),[e]);json.append(c,a);return c}if(e!=m&&i>k&&a.p[e]===b.p[e])if(a.ld!==h)e=p(b),e.p=e.p.slice(k),a.ld=json.apply(p(a.ld),[e]);else if(a.od!==h)e=p(b),e.p=e.p.slice(k),a.od=json.apply(p(a.od),[e]);if(d!=m&&(e=k===i,b.na===h))if(b.si!==h||b.sd!==h){if(a.si!==h||
a.sd!==h){e||g(Error("must be a string?"));k=a.p[k-1];e=b.p[i-1];i={p:k};k={p:e};a.si!=m&&(i.i=a.si);a.sd!=m&&(i.d=a.sd);b.si!=m&&(k.i=b.si);b.sd!=m&&(k.d=b.sd);b=[];q.J(b,i,k,f);k=0;for(e=b.length;k<e;k++)i=b[k],f={p:a.p.slice(0,d)},f.p.push(i.p),i.i!=m&&(f.si=i.i),i.d!=m&&(f.sd=i.d),json.append(c,f);return c}}else if(b.li!==h&&b.ld!==h){if(b.p[d]===a.p[d])if(e){if(a.ld!==h)if(a.li!==h&&f==="client")a.ld=p(b.li);else return c}else return c}else if(b.li!==h)a.li!==h&&a.ld===h&&e&&a.p[d]===b.p[d]?
f==="server"&&a.p[d]++:b.p[d]<=a.p[d]&&a.p[d]++,a.lm!==h&&e&&b.p[d]<=a.lm&&a.lm++;else if(b.ld!==h){if(a.lm!==h&&e){if(b.p[d]===a.p[d])return c;f=b.p[d];e=a.p[d];j=a.lm;(f<j||f===j&&e<j)&&a.lm--}if(b.p[d]<a.p[d])a.p[d]--;else if(b.p[d]===a.p[d])if(i<k)return c;else if(a.ld!==h)if(a.li!==h)delete a.ld;else return c}else if(b.lm!==h)if(a.lm!==h&&k===i){if(e=a.p[d],j=a.lm,i=b.p[d],b=b.lm,i!==b)if(e===i)if(f==="client")a.p[d]=b,e===j&&(a.lm=b);else return c;else e>i&&a.p[d]--,e>b?a.p[d]++:e===b&&i>b&&
(a.p[d]++,e===j&&a.lm++),j>i?a.lm--:j===i&&j>e&&a.lm--,j>b?a.lm++:j===b&&(b>i&&j>e||b<i&&j<e?f==="server"&&a.lm++:j>e?a.lm++:j===i&&a.lm--)}else a.li!==h&&a.ld===h&&e?(e=b.p[d],j=b.lm,f=a.p[d],f>e&&a.p[d]--,f>j&&a.p[d]++):(e=b.p[d],j=b.lm,f=a.p[d],f===e?a.p[d]=j:(f>e&&a.p[d]--,f>j?a.p[d]++:f===j&&e>j&&a.p[d]++));else if(b.oi!==h&&b.od!==h){if(a.p[d]===b.p[d])if(a.oi!==h&&e)if(f==="server")return c;else a.od=b.oi;else return c}else if(b.oi!==h){if(a.oi!==h&&a.p[d]===b.p[d])if(f==="client")json.append(c,
{p:a.p,od:b.oi});else return c}else if(b.od!==h&&a.p[d]===b.p[d]){if(!e)return c;if(a.oi!==h)delete a.od;else return c}json.append(c,a);return c};n.types||(n.types={});C(json,json.R,json.K,json.append);n.types.json=json;B||(B=n.types);window.io||g(Error("Must load socket.io before this library"));J=window.io;t=function(){function c(a,b,c,d,e){this.A=a;this.name=b;this.version=c;this.type=d;this.s=l(this.s,this);this.k=l(this.k,this);this.type.l==m&&g(Error("Handling types without compose() defined is not currently implemented"));
this.snapshot=e;this.b=m;this.o=[];this.e=m;this.t=[];this.H={};this.W=[]}c.prototype.k=function(){if(this.b===m&&this.e!==m)return this.b=this.e,this.o=this.t,this.e=m,this.t=[],this.A.send({doc:this.name,op:this.b,v:this.version},l(function(a){var b,c,d,e;if(a.v===m){e=this.o;c=0;for(d=e.length;c<d;c++)b=e[c],b(m);this.b=m;g(Error(a.error))}a.v!==this.version&&g(Error("Invalid version from server"));this.H[this.version]=this.b;this.version++;d=this.o;a=0;for(c=d.length;a<c;a++)b=d[a],b(this.b,m);
this.b=m;return this.k()},this))};c.prototype.s=function(a){var b,c;if(!(a.v<this.version)){a.doc!==this.name&&g(Error("Expected docName "+this.name+" but got "+a.doc));a.v!==this.version&&g(Error("Expected version "+this.version+" but got "+a.v));a=a.op;this.H[this.version]=a;b=this.type.S||l(function(a,b){var c,f;f=this.type.transform(a,b,"server");c=this.type.transform(b,a,"client");return[f,c]},this);if(this.b!==m)c=b(a,this.b),a=c[0],this.b=c[1];if(this.e!==m)b=b(a,this.e),a=b[0],this.e=b[1];
this.snapshot=this.type.apply(this.snapshot,a);this.version++;this.a("remoteop",a);return this.a("change",a)}};c.prototype.Q=function(a,b,c){var d;if(b==m)b=this.version;if(typeof b==="function")c=b,b=this.version;if(((d=this.type)!=m?d.normalize:h)!=m)a=this.type.normalize(a);for(;b<this.version;)(d=this.X[b])||g(Error("Op version too old")),a=this.type.transform(a,d,"client"),b++;this.snapshot=this.type.apply(this.snapshot,a);this.e=this.e!==m?this.type.l(this.e,a):a;c&&this.t.push(c);this.a("change",
a);return setTimeout(this.k,0)};c.prototype.close=function(a){return this.A.send({doc:this.name,open:!1},l(function(){a&&a();this.a("closed")},this))};return c}();v.G(t);t.prototype.submitOp=t.prototype.Q;t.prototype.close=t.prototype.close;y=function(){function c(a,b,c){this.r=l(this.r,this);this.m=l(this.m,this);this.n=l(this.n,this);this.h=new J.Socket(a,{port:b,Y:c?path+"/socket.io":"socket.io"});this.h.on("connect",this.m);this.h.on("disconnect",this.n);this.h.on("message",this.r);this.h.connect();
this.D=this.C=m;this.f={};this.q=0}c.prototype.n=function(){return this.a("disconnect")};c.prototype.m=function(){return this.a("connect")};c.prototype.send=function(a,b){var c,d;c=a.doc;c===this.D?delete a.doc:this.D=c;this.h.send(a);if(b)return d=l(function(a){var d;d=l(function(i){if(i.doc===c)return this.u(a,d),b(i)},this);return this.g(a,d)},this),d(a.open===!0?"open":a.open===!1?"close":a.create?"create":a.snapshot===m?"snapshot":a.op?"op response":h)};c.prototype.r=function(a){var b,c;b=a.doc;
b!==h?this.C=b:a.doc=b=this.C;this.a("message",a);c=a.open===!0||a.open===!1&&a.error?"open":a.open===!1?"close":a.snapshot!==h?"snapshot":a.create?"create":a.op?"op":a.v!==h?"op response":h;this.a(c,a);if(c==="op"&&(b=this.f[b]))return b.s(a)};c.prototype.F=function(a){var b,c;c=a.doc;this.f[c]&&g(Error("Document "+c+" already followed"));b=a.type;typeof b==="string"&&(b=B[b]);b=new t(this,c,a.v,b,a.snapshot);b.created=!!a.create;this.f[c]=b;this.q++;b.g("closed",l(function(){delete this.f[c];return this.q--},
this));return b};c.prototype.openExisting=function(a,b){if(this.f[a]!=m)return this.f[a];return this.send({doc:a,open:!0,snapshot:m},l(function(a){return a.error?b(m,Error(a.error)):b(this.F(a))},this))};c.prototype.open=function(a,b,c){typeof b==="function"&&(c=b,b="text");c||(c=function(){});typeof b==="string"&&(b=B[b]);if(this.f[a]!=m)a=this.f[a],a.type===b?c(a):c(a,"Type mismatch");else return this.send({doc:a,open:!0,create:!0,snapshot:m,type:b.name},l(function(a){return a.error?c(m,Error(a.error)):
(a.snapshot===h&&(a.snapshot=b.B()),a.type=b,c(this.F(a)))},this))};c.prototype.create=function(a,b){return E(m,a,b)};c.prototype.disconnect=function(){if(this.I!=m)return this.a("disconnected"),this.I.L(),this.I=m};return c}();v.G(y);x={};H=function(c,a,b){var f;if(c==m)c=window.location.hostname;if(a==m)a=window.location.port;f=c;a!=m&&(f+=":"+a);x[f]||(c=new y(c,a,b),c.g("disconnected",function(){return delete x[f]}),x[f]=c);return x[f]};E=function(c,a,b,f){var d;typeof b==="function"&&(f=b,b=
m);b==m&&(b={});d=H(b.host,b.port,b.U);return d.open(c,a,function(a){a.g("closed",function(){return setTimeout(function(){if(d.q===0)return d.L()},0)});return f(a)})};n.Connection=y;n.Document=t;n.open=E;window.sharejs=n}).call(this);