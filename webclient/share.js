/*
 ShareJS v0.1.1
 http://sharejs.org

 Copyright 2011 Joseph Gentle

 BSD licensed:
 https://github.com/josephg/ShareJS/raw/master/LICENSE
*/
var f=void 0,l=null;
(function(){function h(b,a){return function(){return b.apply(a,arguments)}}var q,m,n,i,v,o,w,p,k,x,y,z,u,r,j,s,t,A=Array.prototype.slice;k={};n=function(){function b(){}b.prototype.g=function(a,c){var b;this.c||(this.c={});(b=this.c)[a]||(b[a]=[]);this.c[a].push(c);return this};b.prototype.s=function(a,c){var b,e;this.c||(this.c={});b=(e=this.c[a])!=l?e.indexOf(c):f;b!=l&&b>=0&&this.c[a].splice(b,1);return this};b.prototype.a=function(){var a,c,b,e,g;c=arguments[0];a=2<=arguments.length?A.call(arguments,
1):[];if(!((b=this.c)!=l&&b[c]))return this;g=this.c[c];b=0;for(e=g.length;b<e;b++)c=g[b],c.apply(this,a);return this};return b}();n.B=function(b){b=b.prototype||b;b.g=b.on=n.prototype.g;b.s=b.removeListener=n.prototype.s;b.a=n.prototype.a};if(typeof module!=="undefined"&&module!==l&&module.H)module.H=n;j={name:"text",O:function(){return""}};r=function(b,a,c){return b.slice(0,a)+c+b.slice(a)};v=function(b){if(typeof b.p!=="number")throw Error("component missing position field");if(!(typeof b.i===
"string"^typeof b.d==="string"))throw Error("component needs an i or d field");if(!(b.p>=0))throw Error("position cannot be negative");};o=function(b){var a,c,d;c=0;for(d=b.length;c<d;c++)a=b[c],v(a);return!0};j.apply=function(b,a){var c,d,e,g;o(a);e=0;for(g=a.length;e<g;e++)if(c=a[e],c.i!=l)b=r(b,c.p,c.i);else{d=b.slice(c.p,c.p+c.d.length);if(c.d!==d)throw Error("Delete component '"+c.d+"' does not match deleted text '"+d+"'");b=b.slice(0,c.p)+b.slice(c.p+c.d.length)}return b};j.K=i=function(b,a){var c,
d,e;if(!(a.i===""||a.d===""))return b.length===0?b.push(a):(c=b[b.length-1],c.i!=l&&a.i!=l&&c.p<=(d=a.p)&&d<=c.p+c.i.length?b[b.length-1]={i:r(c.i,a.p-c.p,a.i),p:c.p}:c.d!=l&&a.d!=l&&a.p<=(e=c.p)&&e<=a.p+a.d.length?b[b.length-1]={d:r(a.d,c.p-a.p,c.d),p:a.p}:b.push(a))};j.t=w=function(b,a){var c,d,e,g;o(b);o(a);d=b.slice();e=0;for(g=a.length;e<g;e++)c=a[e],i(d,c);return d};j.N=function(b){return w([],b)};j.normalize=function(b){var a,c,d,e;c=[];if(b.i!=l||b.p!=l)b=[b];d=0;for(e=b.length;d<e;d++)a=
b[d],a.p==l&&(a.p=0),i(c,a);return c};s=function(b,a,c){return a.i!=l?a.p<b||a.p===b&&c?b+a.i.length:b:b<=a.p?b:b<=a.p+a.d.length?a.p:b-a.d.length};j.transformCursor=function(b,a,c){var d,e,g;e=0;for(g=a.length;e<g;e++)d=a[e],b=s(b,d,c);return b};y=function(b){return b.i!=l?{d:b.i,p:b.p}:{i:b.d,p:b.p}};j.P=function(b){var a,c,d,e;d=b.slice().reverse();e=[];a=0;for(c=d.length;a<c;a++)b=d[a],e.push(y(b));return e};require("./helpers").M(j,function(b,a,c,d){var e,g;o([a]);o([c]);if(a.i!=l)i(b,{i:a.i,
p:s(a.p,c,d==="server")});else if(c.i!=l)d=a.d,a.p<c.p&&(i(b,{d:d.slice(0,c.p-a.p),p:a.p}),d=d.slice(c.p-a.p)),d!==""&&i(b,{d:d,p:a.p+c.i.length});else if(a.p>=c.p+c.d.length)i(b,{d:a.d,p:a.p-c.d.length});else if(a.p+a.d.length<=c.p)i(b,a);else{d={d:"",p:a.p};a.p<c.p&&(d.d=a.d.slice(0,c.p-a.p));a.p+a.d.length>c.p+c.d.length&&(d.d+=a.d.slice(c.p+c.d.length-a.p));g=Math.max(a.p,c.p);e=Math.min(a.p+a.d.length,c.p+c.d.length);a=a.d.slice(g-a.p,e-a.p);e=c.d.slice(g-c.p,e-c.p);if(a!==e)throw Error("Delete ops delete different text in the same region of the document");
if(d.d!=="")d.p=s(d.p,c),i(b,d)}return b},o,i);k.types||(k.types={});k.types.text=j;t||(t=k.types);if(!window.io)throw Error("Must load socket.io before this library");z=window.io;m=function(){function b(a,c,b,e,g){this.u=a;this.name=c;this.version=b;this.type=e;this.q=h(this.q,this);this.j=h(this.j,this);if(this.type.t==l)throw Error("Handling types without compose() defined is not currently implemented");this.snapshot=g;this.b=l;this.m=[];this.e=l;this.r=[];this.C={};this.Q=[]}b.prototype.j=function(){if(this.b===
l&&this.e!==l)return this.b=this.e,this.m=this.r,this.e=l,this.r=[],this.u.send({doc:this.name,op:this.b,v:this.version},h(function(a){var c,b,e,g;if(a.v===l){g=this.m;b=0;for(e=g.length;b<e;b++)c=g[b],c(l);this.b=l;throw Error(a.error);}if(a.v!==this.version)throw Error("Invalid version from server");this.C[this.version]=this.b;this.version++;e=this.m;a=0;for(b=e.length;a<b;a++)c=e[a],c(this.b,l);this.b=l;return this.j()},this))};b.prototype.q=function(a){var c,b;if(!(a.v<this.version)){if(a.doc!==
this.name)throw Error("Expected docName "+this.name+" but got "+a.doc);if(a.v!==this.version)throw Error("Expected version "+this.version+" but got "+a.v);a=a.op;this.C[this.version]=a;c=this.type.T||h(function(a,c){var b,d;d=this.type.transform(a,c,"server");b=this.type.transform(c,a,"client");return[d,b]},this);if(this.b!==l)b=c(a,this.b),a=b[0],this.b=b[1];if(this.e!==l)c=c(a,this.e),a=c[0],this.e=c[1];this.snapshot=this.type.apply(this.snapshot,a);this.version++;this.a("remoteop",a);return this.a("change",
a)}};b.prototype.J=function(a,c,b){var e;if(c==l)c=this.version;if(typeof c==="function")b=c,c=this.version;if(((e=this.type)!=l?e.normalize:f)!=l)a=this.type.normalize(a);for(;c<this.version;){e=this.R[c];if(!e)throw Error("Op version too old");a=this.type.transform(a,e,"client");c++}this.snapshot=this.type.apply(this.snapshot,a);this.e=this.e!==l?this.type.t(this.e,a):a;b&&this.r.push(b);this.a("change",a);return setTimeout(this.j,0)};b.prototype.close=function(a){return this.u.send({doc:this.name,
open:!1},h(function(){a&&a();this.a("closed")},this))};return b}();n.B(m);m.prototype.submitOp=m.prototype.J;m.prototype.close=m.prototype.close;q=function(){function b(a,c,b){this.o=h(this.o,this);this.k=h(this.k,this);this.l=h(this.l,this);this.h=new z.Socket(a,{port:c,S:b?path+"/socket.io":"socket.io"});this.h.on("connect",this.k);this.h.on("disconnect",this.l);this.h.on("message",this.o);this.h.connect();this.z=this.w=l;this.f={};this.n=0}b.prototype.l=function(){return this.a("disconnect")};
b.prototype.k=function(){return this.a("connect")};b.prototype.send=function(a,c){var b,e;b=a.doc;b===this.z?delete a.doc:this.z=b;this.h.send(a);if(c)return e=h(function(a){var e;e=h(function(h){if(h.doc===b)return this.s(a,e),c(h)},this);return this.g(a,e)},this),e(a.open===!0?"open":a.open===!1?"close":a.create?"create":a.snapshot===l?"snapshot":a.op?"op response":f)};b.prototype.o=function(a){var c,b;c=a.doc;c!==f?this.w=c:a.doc=c=this.w;this.a("message",a);b=a.open===!0||a.open===!1&&a.error?
"open":a.open===!1?"close":a.snapshot!==f?"snapshot":a.create?"create":a.op?"op":a.v!==f?"op response":f;this.a(b,a);if(b==="op"&&(c=this.f[c]))return c.q(a)};b.prototype.A=function(a){var b,d;d=a.doc;if(this.f[d])throw Error("Document "+d+" already followed");b=a.type;typeof b==="string"&&(b=t[b]);b=new m(this,d,a.v,b,a.snapshot);b.created=!!a.create;this.f[d]=b;this.n++;b.g("closed",h(function(){delete this.f[d];return this.n--},this));return b};b.prototype.openExisting=function(a,b){if(this.f[a]!=
l)return this.f[a];return this.send({G:a,open:!0,I:l},h(function(a){return a.error?b(l,Error(a.error)):b(this.A(a))},this))};b.prototype.open=function(a,b,d){typeof b==="function"&&(d=b,b="text");d||(d=function(){});typeof b==="string"&&(b=t[b]);if(this.f[a]!=l)a=this.f[a],a.type===b?d(a):d(a,"Type mismatch");else return this.send({G:a,open:!0,create:!0,I:l,type:b.name},h(function(a){return a.error?d(l,Error(a.error)):(a.snapshot===f&&(a.snapshot=""),a.type=b,d(this.A(a)))},this))};b.prototype.create=
function(a,b){return u(l,a,b)};b.prototype.disconnect=function(){if(this.D!=l)return this.a("disconnected"),this.D.F(),this.D=l};return b}();n.B(q);p={};x=function(b,a,c){var d;if(b==l)b=window.location.hostname;if(a==l)a=window.location.port;d=b;a!=l&&(d+=":"+a);p[d]||(b=new q(b,a,c),b.g("disconnected",function(){return delete p[d]}),p[d]=b);return p[d]};u=function(b,a,c,d){var e;typeof c==="function"&&(d=c,c=l);c==l&&(c={});e=x(c.host,c.port,c.L);return e.open(b,a,function(a){a.g("closed",function(){return setTimeout(function(){if(e.n===
0)return e.F()},0)});return d(a)})};k.Connection=q;k.Document=m;k.open=u;window.sharejs=k}).call(this);