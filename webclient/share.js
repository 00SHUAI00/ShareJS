(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E=[].slice,S=function(e,t){return function(){return e.apply(t,arguments)}};window.sharejs=c={version:"0.6.0"},d=function(e){return setTimeout(e,0)},r=function(){function e(){}return e.prototype.on=function(e,t){var n;return this._events||(this._events={}),(n=this._events)[e]||(n[e]=[]),this._events[e].push(t),this},e.prototype.removeListener=function(e,t){var n,r,i,s=this;this._events||(this._events={}),r=(i=this._events)[e]||(i[e]=[]),n=0;while(n<r.length)r[n]===t&&(r[n]=void 0),n++;return d(function(){var t;return s._events[e]=function(){var n,r,i=this._events[e],s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t&&s.push(t);return s}.call(s)}),this},e.prototype.emit=function(){var e,t,n,r,i,s=arguments[0],o=2<=arguments.length?E.call(arguments,1):[];if((r=this._events)!=null?!r[s]:!void 0)return s==="error"&&typeof console!="undefined"&&console!==null&&console.error.apply(console,o),this;i=this._events[s];for(t=0,n=i.length;t<n;t++)e=i[t],e&&e.apply(this,o);return this},e}(),r.mixin=function(e){var t=e.prototype||e;return t.on=r.prototype.on,t.removeListener=r.prototype.removeListener,t.emit=r.prototype.emit,e},c._bt=a=function(e,t,n,r){var i,s=function(e,n,r,i){return t(r,e,n,"left"),t(i,n,e,"right")};return e.transformX=e.transformX=i=function(e,t){var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;n(e),n(t),l=[];for(v=0,b=t.length;v<b;v++){d=t[v],f=[],o=0;while(o<e.length){c=[],s(e[o],d,f,c),o++;if(c.length!==1){if(c.length===0){x=e.slice(o);for(m=0,w=x.length;m<w;m++)u=x[m],r(f,u);d=null;break}T=i(e.slice(o),c),a=T[0],p=T[1];for(g=0,E=a.length;g<E;g++)u=a[g],r(f,u);for(y=0,S=p.length;y<S;y++)h=p[y],r(l,h);d=null;break}d=c[0]}d!=null&&r(l,d),e=f}return[e,l]},e.transform=e.transform=function(e,n,r){var s,o,u,a,f;if(r!=="left"&&r!=="right")throw new Error("type must be 'left' or 'right'");return n.length===0?e:e.length===1&&n.length===1?t([],e[0],n[0],r):r==="left"?(a=i(e,n),s=a[0],u=a[1],s):(f=i(n,e),u=f[0],o=f[1],o)}},g={},g.name="text",g.create=function(){return""},m=function(e,t,n){return e.slice(0,t)+n+e.slice(t)},f=function(e){var t,n;if(typeof e.p!="number")throw new Error("component missing position field");n=typeof e.i,t=typeof e.d;if(!(n==="string"^t==="string"))throw new Error("component needs an i or d field");if(!(e.p>=0))throw new Error("position cannot be negative")},l=function(e){var t,n,r;for(n=0,r=e.length;n<r;n++)t=e[n],f(t);return!0},g.apply=function(e,t){var n,r,i,s;l(t);for(i=0,s=t.length;i<s;i++){n=t[i];if(n.i!=null)e=m(e,n.p,n.i);else{r=e.slice(n.p,n.p+n.d.length);if(n.d!==r)throw new Error("Delete component '"+n.d+"' does not match deleted text '"+r+"'");e=e.slice(0,n.p)+e.slice(n.p+n.d.length)}}return e},g._append=u=function(e,t){var n,r,i;if(t.i===""||t.d==="")return;return e.length===0?e.push(t):(n=e[e.length-1],n.i!=null&&t.i!=null&&n.p<=(r=t.p)&&r<=n.p+n.i.length?e[e.length-1]={i:m(n.i,t.p-n.p,t.i),p:n.p}:n.d!=null&&t.d!=null&&t.p<=(i=n.p)&&i<=t.p+t.d.length?e[e.length-1]={d:m(t.d,n.p-t.p,n.d),p:t.p}:e.push(t))},g.compose=function(e,t){var n,r,i,s;l(e),l(t),r=e.slice();for(i=0,s=t.length;i<s;i++)n=t[i],u(r,n);return r},g.compress=function(e){return g.compose([],e)},g.normalize=function(e){var t,n,r,i,s=[];if(e.i!=null||e.p!=null)e=[e];for(n=0,r=e.length;n<r;n++)t=e[n],(i=t.p)==null&&(t.p=0),u(s,t);return s},b=function(e,t,n){return t.i!=null?t.p<e||t.p===e&&n?e+t.i.length:e:e<=t.p?e:e<=t.p+t.d.length?t.p:e-t.d.length},g.transformCursor=function(e,t,n){var r,i,s,o=n==="right";for(i=0,s=t.length;i<s;i++)r=t[i],e=b(e,r,o);return e},g._tc=y=function(e,t,n,r){var i,s,o,a,f,c;l([t]),l([n]);if(t.i!=null)u(e,{i:t.i,p:b(t.p,n,r==="right")});else if(n.i!=null)c=t.d,t.p<n.p&&(u(e,{d:c.slice(0,n.p-t.p),p:t.p}),c=c.slice(n.p-t.p)),c!==""&&u(e,{d:c,p:t.p+n.i.length});else if(t.p>=n.p+n.d.length)u(e,{d:t.d,p:t.p-n.d.length});else if(t.p+t.d.length<=n.p)u(e,t);else{a={d:"",p:t.p},t.p<n.p&&(a.d=t.d.slice(0,n.p-t.p)),t.p+t.d.length>n.p+n.d.length&&(a.d+=t.d.slice(n.p+n.d.length-t.p)),o=Math.max(t.p,n.p),s=Math.min(t.p+t.d.length,n.p+n.d.length),i=t.d.slice(o-t.p,s-t.p),f=n.d.slice(o-n.p,s-n.p);if(i!==f)throw new Error("Delete ops delete different text in the same region of the document");a.d!==""&&(a.p=b(a.p,n),u(e,a))}return e},p=function(e){return e.i!=null?{d:e.i,p:e.p}:{i:e.d,p:e.p}},g.invert=function(e){var t,n,r,i=e.slice().reverse(),s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(p(t));return s},c.types||(c.types={}),a(g,y,l,u),c.types.text=g,g.api={provides:{text:!0},getLength:function(){return this.snapshot.length},getText:function(){return this.snapshot},insert:function(e,t,n){var r=[{p:e,i:t}];return this.submitOp(r,n),r},del:function(e,t,n){var r=[{p:e,d:this.snapshot.slice(e,e+t)}];return this.submitOp(r,n),r},_register:function(){return this.on("remoteop",function(e){var t,n,r,i=[];for(n=0,r=e.length;n<r;n++)t=e[n],t.i!==void 0?i.push(this.emit("insert",t.p,t.i)):i.push(this.emit("delete",t.p,t.d));return i})}},c.extendDoc=function(e,t){return n.prototype[e]=t},n=function(){function e(e,t,n,r){this.connection=e,this.collection=t,this.name=n,this.flush=S(this.flush,this),r||(r={}),this.version=r.v,this.snapshot=r.snaphot,r.type&&this._setType(r.type),this.state="closed",this.autoOpen=!1,this._create=r.create,this.inflightOp=null,this.inflightCallbacks=[],this.pendingOp=null,this.pendingCallbacks=[],this.serverOps={}}return e.prototype._send=function(e){return e.c=this.collection,e.doc=this.name,this.connection.send(e)},e.prototype._xf=function(e,t){var n,r;return this.type.transformX?this.type.transformX(e,t):(n=this.type.transform(e,t,"left"),r=this.type.transform(t,e,"right"),[n,r])},e.prototype._otApply=function(e,t){var n=this.snapshot;this.snapshot=this.type.apply(this.snapshot,e),this.emit("change",e,n);if(t)return this.emit("remoteop",e,n)},e.prototype._connectionStateChanged=function(e,t){switch(e){case"disconnected":this.state="closed",this.emit("closed");break;case"connected":this.autoOpen&&this.open();break;case"stopped":typeof this._openCallback=="function"&&this._openCallback(t)}return this.emit(e,t)},e.prototype._setType=function(e){var t,n,r;typeof e=="string"&&(e=w[e]);if(!e||!e.compose)throw new Error("Support for types without compose() is not implemented");this.type=e;if(e.api){r=e.api;for(t in r)n=r[t],this[t]=n;return typeof this._register=="function"?this._register():void 0}return this.provides={}},e.prototype._opConfirmed=function(e){var t,n,r,i,s,o,u,a,f,l,c;if(n==="Op already submitted")return;r=this.inflightOp,this.inflightOp=null,this.sentSrc=this.sentSeq=null,n=e.error;if(n){this.type.invert?(i=this.type.invert(r),this.pendingOp&&(f=this._xf(this.pendingOp,i),this.pendingOp=f[0],i=f[1]),this._otApply(i,!0)):this.emit("error","Op apply failed ("+n+") and the op could not be reverted"),l=this.inflightCallbacks;for(s=0,u=l.length;s<u;s++)t=l[s],t(n)}else{if(e.v!==this.version)throw new Error("Invalid version from server");this.serverOps[this.version]=r,this.version++,this.emit("acknowledge",r),c=this.inflightCallbacks;for(o=0,a=c.length;o<a;o++)t=c[o],t(null,r)}return this.inflightCallbacks.length=0,this.flush()},e.prototype._didOpen=function(e){return this.state="open",this._create=!1,e.type&&this._setType(e.type),e.create?this.created=!0:this.created!==!0&&(this.created=!1),e.snapshot!==void 0&&(this.snapshot=e.snapshot),e.meta&&(this.meta=e.meta),e.v!=null&&(this.version=e.v),this.flush(),this.emit("open"),typeof this._openCallback=="function"?this._openCallback(null):void 0},e.prototype._onMessage=function(e){var t,n,r,i,s,o,u;if(e.c!==this.collection||e.doc!==this.name)throw new Error("Got message for wrong document. Expected '"+this.collection+"'.'"+this.name+"' but got '"+e.c+"'.'"+e.doc+"'");switch(e.a){case"sub":if(e.error){typeof console!="undefined"&&console!==null&&console.error("Could not open document: "+e.error),this.emit("error",e.error),typeof this._openCallback=="function"&&this._openCallback(e.error);break}return e.type==null?(this._send({a:"op",v:e.v,create:{type:this.type.uri}}),this.version=e.v):(console.log("already created",e,this.create),this._didOpen(e));case"unsub":return this.state="closed",this.emit("closed"),typeof this._closeCallback=="function"&&this._closeCallback(),this._closeCallback=null;case"ack":if(e.error)return this._opConfirmed(e);break;case"op":if(e.create){this._didOpen(e);break}if(e.src===this.sentSrc&&e.seq===this.sentSeq){this._opConfirmed(e);break}if(e.v!==this.version)return this.emit("error","Expected version "+this.version+" but got "+e.v);return n=e.op,this.serverOps[this.version]=n,t=n,this.inflightOp!==null&&(s=this._xf(this.inflightOp,t),this.inflightOp=s[0],t=s[1]),this.pendingOp!==null&&(o=this._xf(this.pendingOp,t),this.pendingOp=o[0],t=o[1]),this.version++,this._otApply(t,!0);case"meta":return u=e.meta,r=u.path,i=u.value,typeof console!="undefined"&&console!==null?console.warn("Unhandled meta op:",e):void 0;default:return typeof console!="undefined"&&console!==null?console.warn("Unhandled document message:",e):void 0}},e.prototype.flush=function(){if(this.connection.state!=="connected"||this.inflightOp!==null||this.pendingOp===null)return;return this.inflightOp=this.pendingOp,this.inflightCallbacks=this.pendingCallbacks,this.sentSrc=this.connection.id,this.sentSeq=this.connection.seq++,this.pendingOp=null,this.pendingCallbacks=[],this._send({a:"op",op:this.inflightOp,v:this.version})},e.prototype.submitOp=function(e,t){return this.type.normalize!=null&&(e=this.type.normalize(e)),this.snapshot=this.type.apply(this.snapshot,e),this.pendingOp!==null?this.pendingOp=this.type.compose(this.pendingOp,e):this.pendingOp=e,t&&this.pendingCallbacks.push(t),this.emit("change",e),setTimeout(this.flush,0)},e.prototype.open=function(e){var t,n=this;this.autoOpen=!0;if(this.state!=="closed")return;return t={a:"sub"},this.type&&(t.type=this.type.uri),this.version!=null&&(t.v=this.version),this._send(t),this.state="opening",this._openCallback=function(t){return n._openCallback=null,typeof e=="function"?e(t):void 0}},e.prototype.close=function(e){return this.autoOpen=!1,this.state==="closed"?typeof e=="function"?e():void 0:(this._send({open:!1}),this.state="closed",this.emit("closing"),this._closeCallback=e)},e}(),r.mixin(n),c.Doc=n,i=function(){function e(e,t,n){var r,i,s=this;t!=null&&typeof t=="function"?(n=t,t=void 0):typeof n!="function"&&(n=o),this.debug=this.debugAll,this.reconnectInterval=1e3,this.timeoutInterval=2e3,this.forcedClose=!1,this.url=e,this.protocols=t,this.readyState=n.CONNECTING,this.URL=e,i=!1,r=function(e){var t;return s.ws=new n(s.url),s.debug&&console.debug("ReconnectingWebSocket","attempt-connect",s.url),t=setTimeout(function(){return s.debug&&console.debug("ReconnectingWebSocket","connection-timeout",s.url),i=!0,s.ws.close(),i=!1},s.timeoutInterval),s.ws.onopen=function(r){return clearTimeout(t),s.debug&&console.debug("ReconnectingWebSocket","onopen",s.url),s.readyState=n.OPEN,e=!1,s.onopen(r)},s.ws.onclose=function(o){return clearTimeout(t),s.ws=null,s.forcedClose?(s.readyState=n.CLOSED,s.onclose(o)):(s.readyState=n.CONNECTING,s.onconnecting(o),!e&&!i&&(s.debug&&console.debug("ReconnectingWebSocket","onclose",s.url),s.onclose(o)),setTimeout(function(){return r(!0)},s.reconnectInterval))},s.ws.onmessage=function(e){return s.debug&&console.debug("ReconnectingWebSocket","onmessage",s.url,e.data),s.onmessage(e)},s.ws.onerror=function(e){return s.debug&&console.debug("ReconnectingWebSocket","onerror",s.url,e),s.onerror(e)}},r(this.url)}return e.prototype.onopen=function(){},e.prototype.onclose=function(){},e.prototype.onconnecting=function(){},e.prototype.onmessage=function(){},e.prototype.onerror=function(){},e.prototype.send=function(e){if(this.ws)return this.debug&&console.debug("ReconnectingWebSocket","send",this.url,e),this.ws.send(e);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},e.prototype.close=function(){if(this.ws)return this.forcedClose=!0,this.ws.close()},e.prototype.debugAll=!1,e.prototype.refresh=function(){if(this.ws)return this.ws.close()},e}(),w=ottypes,e=window.BCSocket,s=window.SockJS,o=window.WebSocket,e?v="channel":s?v="sockjs":v="websocket",t=function(){function e(e){var t=this;this.socket=e,this.collections={},this.state="disconnected",this.socket.onmessage=function(e){var n,r,i;console.log("RECV",e);if(e.id){if(e.protocol!==0)throw new Error("Invalid protocol version");if(typeof e.id!="string")throw new Error("Invalid client id");t.id=e.id,t.setState("connected");return}return e.doc!==void 0?(n=t.lastReceivedCollection=e.c,i=t.lastReceivedDoc=e.doc):(n=e.c=t.lastReceivedCollection,i=e.doc=t.lastReceivedDoc),(r=t._get(n,i))?r._onMessage(e):typeof console!="undefined"&&console!==null?console.error("Unhandled message",e):void 0},this.connected=!1,this.socket.onclose=function(e){t.setState("disconnected",e);if(e==="Closed"||e==="Stopped by server")return t.setState("stopped",t.lastError||e)},this.socket.onerror=function(e){return t.emit("error",e)},this.socket.onopen=function(){return t.setState("connecting")},this.reset()}return e.prototype._get=function(e,t){var n;return(n=this.collections[e])!=null?n[t]:void 0},e.prototype._error=function(e){return this.setState("stopped",e),this.disconnect(e)},e.prototype.reset=function(){return this.id=this.lastError=this.lastReceivedDoc=this.lastSentDoc=null,this.seq=1},e.prototype.setState=function(e,t){var n,r,i,s,o,u;if(this.state===e)return;if(e==="connecting"&&this.state!=="disconnected"||e==="connected"&&this.state!=="connecting")throw new Error("Cannot transition directly from "+this.state+" to "+e);this.state=e,e==="disconnected"&&this.reset(),this.emit(e,t),o=this.collections,u=[];for(n in o)r=o[n],u.push(function(){var n=[];for(s in r)i=r[s],n.push(i._connectionStateChanged(e,t));return n}());return u},e.prototype.send=function(e){var t,n;return console.log("SEND:",e),e.doc&&(n=e.doc,t=e.c,t===this.lastSentCollection&&n===this.lastSentDoc?(delete e.c,delete e.doc):(this.lastSentCollection=t,this.lastSentDoc=n)),this.socket.send(e)},e.prototype.disconnect=function(){return this.socket.close()},e.prototype.makeDoc=function(e,t,r,i){var s,o,u,a=this;if(this._get(e,t))throw new Error("Doc "+t+" already open");return o=new n(this,e,t,r),s=(u=this.collections)[e]||(u[e]={}),s[t]=o,o.open(function(e){return e?delete s[t]:o.on("closed",function(){return delete s[t]}),i(e,e?void 0:o)})},e.prototype.openExisting=function(e,t,n){var r;return this.state==="stopped"?n("connection closed"):(r=this._get(e,t),r?this._ensureOpenState(r,n):r=this.makeDoc(e,t,{},n))},e.prototype.open=function(e,t,n,r){var i;if(this.state==="stopped")return r("connection closed");if(this.state==="connecting"){this.on("connected",function(){return this.open(e,t,n,r)});return}typeof n=="function"&&(r=n,n="text"),r||(r=function(){}),typeof n=="string"&&(n=w[n]);if(!n)throw new Error("OT code for document type missing");if(t==null)throw new Error("Server-generated random doc names are not currently supported");if(i=this._get(e,t)){i.type===n?this._ensureOpenState(i,r):r("Type mismatch",i);return}return this.makeDoc(e,t,{create:!0,type:n.name},r)},e.prototype._ensureOpenState=function(e,t){switch(e.state){case"open":t(null,e);break;case"opening":this.on("open",function(){return t(null,e)});break;case"closed":e.open(function(n){return t(n,n?void 0:e)})}},e}(),r.mixin(t),c.Connection=t,h=window.BCSocket!==void 0,c.open=function(){var n={},r=function(r,i){var s,o,u;return r==null&&(u=window.location,r=""+u.protocol+"//"+u.host+"/channel"),n[r]||(s=new t(new e(r,{reconnect:!0}),i),o=function(){return delete n[r]},s.on("disconnected",o),s.on("connect failed",o),n[r]=s),n[r]},i=function(e){var t,n,r=0,i=e.docs;for(n in i)t=i[n],(t.state!=="closed"||t.autoOpen)&&r++;if(r===0)return e.disconnect()};return function(e,t,n,s,o){var u,a,f;if(!h)throw new Error("Cannot find browserchannel. If you want to use a custom channel, create a connection manually.");return typeof s=="function"&&(o=s,s={}),typeof s=="string"&&(s={origin:s}),f=s.origin,u=s.authentication,a=r(f,u),a.open(e,t,n,function(e,t){return e?(o(e),i(a)):(t.on("closed",function(){return i(a)}),o(null,t))}),a.on("connect failed"),a}}()}).call(this)