(function(){var t,e,n,o,i,s,r,c,u,a=[].slice;window.sharejs=i={version:"0.7.0"},"undefined"==typeof WEB&&(window.WEB=!0),r="undefined"!=typeof WEB&&null!==WEB?function(t){return setTimeout(t,0)}:process.nextTick,n=function(){function t(){}return t.prototype.on=function(t,e){var n;return this._events||(this._events={}),(n=this._events)[t]||(n[t]=[]),this._events[t].push(e),this},t.prototype.removeListener=function(t,e){var n,o,i,s=this;for(this._events||(this._events={}),o=(i=this._events)[t]||(i[t]=[]),n=0;o.length>n;)o[n]===e&&(o[n]=void 0),n++;return r(function(){var e;return s._events[t]=function(){var n,o,i,s;for(i=this._events[t],s=[],n=0,o=i.length;o>n;n++)e=i[n],e&&s.push(e);return s}.call(s)}),this},t.prototype.emit=function(){var t,e,n,o,i,s,r;if(e=arguments[0],t=arguments.length>=2?a.call(arguments,1):[],!(null!=(s=this._events)?s[e]:void 0))return"error"===e&&"undefined"!=typeof console&&null!==console&&console.error.apply(console,t),this;for(r=this._events[e],o=0,i=r.length;i>o;o++)n=r[o],n&&n.apply(this,t);return this},t.prototype.once=function(t,e){var n,o=this;return this.on(t,n=function(){var i;return i=arguments.length>=1?a.call(arguments,0):[],o.removeListener(t,n),e.apply(o,i)})},t}(),n.mixin=function(t){var e;return e=t.prototype||t,e.on=n.prototype.on,e.removeListener=n.prototype.removeListener,e.emit=n.prototype.emit,e.once=n.prototype.once,t},("undefined"==typeof WEB||null===WEB)&&(module.exports=n),("undefined"==typeof WEB||null===WEB)&&(u=require("ot-types")),"undefined"!=typeof WEB&&null!==WEB&&(i.extendDoc=function(t,n){return e.prototype[t]=n}),e=function(){function t(t,e,n,o){this.connection=t,this.collection=e,this.name=n,this.subscribed=!1,this.subscribeRequested=!1,this.inflightData=null,this.pendingData=[],"number"==typeof(null!=o?o.v:void 0)&&this._injestData(o)}var e;return t.prototype._send=function(t){return t.c=this.collection,t.doc=this.name,this.connection.send(t)},t.prototype.subscribe=function(t){var e,n=this;if(!this.subscribeRequested&&(this.subscribeRequested=!0,t&&(this._subscribeCallback=function(e){return n._subscribeCallback=null,t(e)}),"disconnected"!==this.connection.state))return e={a:"sub"},"number"==typeof this.version&&(e.v=this.version),this._send(e)},t.prototype.unsubscribe=function(t){var e=this;if(this.subscribeRequested&&(this.subscribeRequested=!1,"disconnected"!==this.connection.state))return t&&(this._unsubscribeCallback=function(n){return e._unsubscribeCallback=null,t(n)}),this._send({a:"unsub"})},t.prototype.fetch=function(t){return t&&this.once("fetched",t),this._send({a:"fetch"})},t.prototype._connectionStateChanged=function(t,e){switch(t){case"disconnected":this.subscribed=!1;break;case"connecting":this.subscribeRequested&&(this.subscribeRequested=!1,this.subscribe()),this.inflightData&&this._sendOpData(this.inflightData)}return this.emit(t,e)},t.prototype._setType=function(t){var e,n,o,i;if("string"==typeof t){if(!u[t])throw Error("Missing type "+t);t=u[t]}if(t&&!t.compose)throw Error("Support for types without compose() is not implemented");if(null!=(o=this.type)?o.api:void 0){this._onOp&&this.removeListener("op",this._onOp);for(e in this.type.api)delete this[e]}if(this.type=t,this.type||(this.snapshot=null),null!=t?!t.api:true)return this.provides={};i=t.api;for(e in i)n=i[e],this[e]=n;return this._onOp?this.on("op",this._onOp):void 0},t.prototype._injestData=function(t){if(null==t&&(t={}),void 0===t.snapshot)throw Error("Missing snapshot");if(void 0===t.type)throw Error("Missing type");return"number"==typeof this.version?("undefined"!=typeof console&&null!==console&&console.warn("Ignoring extra attempt to injest data"),void 0):(this.version=t.v,this.snapshot=t.snapshot,this._setType(t.type))},e=function(t){return delete t.op,delete t.create,delete t.del},t.prototype._xf=function(t,n){var o;if(n.create||n.del)return e(t);if(t.del)return e(n);if(t.create)throw Error("Invalid state. This is a bug. Please file an issue on github");if(n.op&&t.op)return t.type.transformX?(o=t.type.transformX(t.op,n.op),t.op=o[0],n.op=o[1],o):(t.op=this.type.transform(t.op,n.op,"left"),n.op=this.type.transform(n.op,t.op,"right"))},t.prototype._otApply=function(t,e){var n,o,i=this;if(this.locked=!0,n=t.create)return this._setType(n.type),this.snapshot=this.type.create(n.data),setTimeout(function(){return i.emit("ready",e)},0),setTimeout(function(){return i.emit("created",e)},0);if(t.del)return this._setType(null),setTimeout(function(){return i.emit("deleted",e)},0);if(o=t.op){if(!this.type)throw Error("Document does not exist");return o=t.op,this.emit("before op",o,e),this.incremental&&this.type.incrementalApply?this.type.incrementalApply(this.snapshot,o,function(t,n){return i.snapshot=n,i.emit("op",t,e)}):(this.snapshot=this.type.apply(this.snapshot,o),this.emit("op",o,e))}return"undefined"!=typeof console&&null!==console?console.warn("Ignoring received no-op.",t):void 0},t.prototype._afterOtApply=function(t,e){return this.locked=!1,t.op?this.emit("after op",t.op,e):void 0},t.prototype._tryRollback=function(t){var e,n,o,i,s;if(t.create)return this._setType(null);if(t.op&&t.type.invert){for(n=t.type.invert(t.op),s=this.pendingData,o=0,i=s.length;i>o;o++)e=s[o],this._xf(e,n);return this._otApply(n,!1),this._afterOtApply(n,!1)}return this.emit("error","Op apply failed and the operation could not be reverted"),this._setType(null),this.v=null,this.fetch()},t.prototype._opAcknowledged=function(t){var e,n,o,i,s,r;if("Op already submitted"!==o){if(e=this.inflightData,this.inflightData=null,o=t.error)this._tryRollback(e);else{if(t.v!==this.version)throw Error("Invalid version from server. Please file an issue, this is a bug.");this.version++,this.emit("acknowledge",e)}for(r=e.callbacks,i=0,s=r.length;s>i;i++)n=r[i],n(o);return this.flush()}},t.prototype._onMessage=function(t){var e,n,o,i,s,r,c,u;if(t.c!==this.collection||t.doc!==this.name)throw Error("Got message for wrong document. Expected '"+this.collection+"'.'"+this.name+"' but got '"+t.c+"'.'"+t.doc+"'");switch(t.a){case"data":return this._injestData(t),this.type&&this.emit("ready"),this.emit("fetched");case"sub":if(t.error){"undefined"!=typeof console&&null!==console&&console.error("Could not open document: "+t.error),this.emit("error",t.error),this.subscribed=!1,this.subscribeRequested=!1,"function"==typeof this._subscribeCallback&&this._subscribeCallback(t.error);break}return this.subscribed=!0,this.emit("subscribed"),"function"==typeof this._subscribeCallback&&this._subscribeCallback(),this.flush();case"unsub":return this.subscribed=!1,this.emit("unsubscribed"),"function"==typeof this._unsubscribeCallback?this._unsubscribeCallback():void 0;case"ack":if(t.error)return this._opAcknowledged(t);break;case"op":if(this.inflightData&&t.src===this.inflightData.src&&t.seq===this.inflightData.seq){this._opAcknowledged(t);break}if(t.v!==this.version)return this.emit("error","Expected version "+this.version+" but got "+t.v);for(e=t,this.inflightData&&this._xf(this.inflightData,e),c=this.pendingData,s=0,r=c.length;r>s;s++)o=c[s],this._xf(o,e);return this.version++,this._otApply(e,!1),this._afterOtApply(e,!1);case"meta":return u=t.meta,n=u.path,i=u.value,"undefined"!=typeof console&&null!==console?console.warn("Unhandled meta op:",t):void 0;default:return"undefined"!=typeof console&&null!==console?console.warn("Unhandled document message:",t):void 0}},t.prototype._submitOpData=function(t,e){var n,o,i=this;return o=function(t){return e?e(t):"undefined"!=typeof console&&null!==console?console.warn("Failed attempt to submitOp:",t):void 0},this.subscribeRequested?this.locked?o("Cannot call submitOp from inside an 'op' event handler"):(t.op&&(this.type||o("Document has not been created"),null!=this.type.normalize&&(t.op=this.type.normalize(t.op))),this._otApply(t,!0),t.op&&this.pendingData.length&&(n=this.pendingData[this.pendingData.length-1]).op?n.op=this.type.compose(n.op,t.op):(n=t,t.type=this.type,t.callbacks=[],this.pendingData.push(t)),e&&n.callbacks.push(e),this._afterOtApply(t,!0),setTimeout(function(){return i.flush()},0)):o("You cannot currently submit operations to an unsubscribed document")},t.prototype.submitOp=function(t,e){return this._submitOpData({op:t},e)},t.prototype.create=function(t,e,n){var o;return"function"==typeof e&&(o=[void 0,e],e=o[0],n=o[1]),this.type?"function"==typeof n?n("Document already exists"):void 0:this._submitOpData({create:{type:t,data:e}},n)},t.prototype.del=function(t){return this.type?this._submitOpData({del:!0},t):"function"==typeof t?t("Document does not exist"):void 0},t.prototype._sendOpData=function(t){var e;return e={a:"op",v:this.version},t.src&&(e.src=t.src,e.seq=t.seq),t.op&&(e.op=t.op),t.create&&(e.create=t.create),t.del&&(e.del=t.del),this._send(e),t.src?void 0:(t.src=this.connection.id,t.seq=this.connection.seq++)},t.prototype.flush=function(){var t;if(("connecting"===(t=this.connection.state)||"connected"===t)&&null===this.inflightData&&this.pendingData.length)return this.inflightData=this.pendingData.shift(),this._sendOpData(this.inflightData)},t.prototype.getSnapshot=function(){return this.snapshot},t}(),("undefined"==typeof WEB||null===WEB)&&(n=require("./microevent")),n.mixin(e),i.Doc=e,u="undefined"!=typeof WEB&&null!==WEB?ottypes:require("ot-types"),t=function(){function t(t){var e=this;this.socket=t,this.collections={},this.state="disconnected",this.socket.onmessage=function(t){var n,o,i;if(console.log("RECV",t),t.id){if(0!==t.protocol)throw Error("Invalid protocol version");if("string"!=typeof t.id)throw Error("Invalid client id");return e.id=t.id,e.setState("connected"),void 0}return void 0!==t.doc?(n=e.lastReceivedCollection=t.c,i=e.lastReceivedDoc=t.doc):(n=t.c=e.lastReceivedCollection,i=t.doc=e.lastReceivedDoc),(o=e.get(n,i))?o._onMessage(t):"undefined"!=typeof console&&null!==console?console.error("Unhandled message",t):void 0},this.connected=!1,this.socket.onclose=function(t){return e.setState("disconnected",t),"Closed"===t||"Stopped by server"===t?e.setState("stopped",e.lastError||t):void 0},this.socket.onerror=function(t){return e.emit("error",t)},this.socket.onopen=function(){return e.setState("connecting")},this.reset()}return t.prototype._error=function(t){return this.setState("stopped",t),this.disconnect(t)},t.prototype.reset=function(){return this.id=this.lastError=this.lastReceivedDoc=this.lastSentDoc=null,this.seq=1},t.prototype.setState=function(t,e){var n,o,i,s,r,c;if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state||"connected"===t&&"connecting"!==this.state)throw Error("Cannot transition directly from "+this.state+" to "+t);this.state=t,"disconnected"===t&&this.reset(),this.emit(t,e),r=this.collections,c=[];for(n in r)o=r[n],c.push(function(){var n;n=[];for(s in o)i=o[s],n.push(i._connectionStateChanged(t,e));return n}());return c}},t.prototype.send=function(t){var e,n;return console.log("SEND:",t),t.doc&&(n=t.doc,e=t.c,e===this.lastSentCollection&&n===this.lastSentDoc?(delete t.c,delete t.doc):(this.lastSentCollection=e,this.lastSentDoc=n)),this.socket.send(t)},t.prototype.disconnect=function(){return this.socket.close()},t.prototype.get=function(t,e){var n;return null!=(n=this.collections[t])?n[e]:void 0},t.prototype.getOrCreate=function(t,n,o){var i,s;return(i=this.get(t,n))?i:(i=new e(this,t,n,o),t=(s=this.collections)[t]||(s[t]={}),t[n]=i)},t}(),("undefined"==typeof WEB||null===WEB)&&(n=require("./microevent")),n.mixin(t),i.Connection=t,"undefined"!=typeof WEB&&null!==WEB?s=void 0!==window.BCSocket:t=require("./connection").Connection,i.open=function(){var e,n,o;return e={},n=function(n,o){var i,s,r;return"undefined"!=typeof WEB&&null!==WEB&&null==n&&(r=window.location,n=""+r.protocol+"//"+r.host+"/channel"),e[n]||(i=new t(new BCSocket(n,{reconnect:!0}),o),s=function(){return delete e[n]},i.on("disconnected",s),i.on("connect failed",s),e[n]=i),e[n]},o=function(t){var e,n,o,i;o=0,i=t.docs;for(n in i)e=i[n],("closed"!==e.state||e.autoOpen)&&o++;return 0===o?t.disconnect():void 0},function(t,e,i,r,c){var u,a,l;if(!s)throw Error("Cannot find browserchannel. If you want to use a custom channel, create a connection manually.");return"function"==typeof r&&(c=r,r={}),"string"==typeof r&&(r={origin:r}),l=r.origin,u=r.authentication,a=n(l,u),a.open(t,e,i,function(t,e){return t?(c(t),o(a)):(e.on("closed",function(){return o(a)}),c(null,e))}),a.on("connect failed"),a}}(),("undefined"==typeof WEB||null===WEB)&&(i.Doc=require("./doc").Doc,i.Connection=require("./connection").Connection),o=function(t,e,n){var o,i;if(e!==n){for(i=0;e.charAt(i)===n.charAt(i);)i++;for(o=0;e.charAt(e.length-1-o)===n.charAt(n.length-1-o)&&e.length>o+i&&n.length>o+i;)o++;return e.length!==i+o&&t.remove(i,e.length-i-o),n.length!==i+o?t.insert(i,n.slice(i,n.length-o)):void 0}},window.sharejs.extendDoc("attach_textarea",function(t){var e,n,i,s,r,c,u;return i=this,u=function(e,n){var o,i;return o=[n(t.selectionStart),n(t.selectionEnd)],i=t.scrollTop,t.value=e,t.scrollTop!==i&&(t.scrollTop=i),window.document.activeElement===t?(t.selectionStart=o[0],t.selectionEnd=o[1],o):void 0},r=function(e,n){var o,i;return i=function(t){return t>e?t+n.length:t},o=t.value.replace(/\r\n/g,"\n"),u(o.slice(0,e)+n+o.slice(e),i)},c=function(e,n){var o,i;return i=function(t){return t>e?t-Math.min(n,t-e):t},o=t.value.replace(/\r\n/g,"\n"),u(o.slice(0,e)+o.slice(e+n),i)},s=function(){var e;return e=function(t){return setTimeout(t,0)},e(function(){var e;return t.value!==e?(e=t.value,o(i,i.getText(),t.value.replace(/\r\n/g,"\n"))):void 0})},e=function(){var e,o,u,a,l;if(!i.provides.text)return"undefined"!=typeof console&&null!==console?console.warn("Could not attach document: text api incompatible"):void 0;for(o=t.value=i.getText(),i.on("insert",r),i.on("remove",c),l=["textInput","keydown","keyup","select","cut","paste"],u=0,a=l.length;a>u;u++)e=l[u],t.addEventListener?t.addEventListener(e,s,!1):t.attachEvent("on"+e,s);return i.once("deleted",n)},n=t.detach_share=function(){var n,o,u,a;for(i.removeListener("insert",r),i.removeListener("remove",c),a=["textInput","keydown","keyup","select","cut","paste"],o=0,u=a.length;u>o;o++)n=a[o],t.removeEventListener?t.removeEventListener(n,s,!1):t.detachEvent("on"+n,s);return t.disabled=!0,i.once("ready",e)},i.type?e():i.once("ready",e)}),c="undefined"!=typeof WEB&&null!==WEB?ottypes.text:require("./text"),c.api={provides:{text:!0},getLength:function(){return this.getSnapshot().length},getText:function(){return this.getSnapshot()},insert:function(t,e,n){var o;return o=c.normalize([t,e]),this.submitOp(o,n),o},remove:function(t,e,n){var o;return o=c.normalize([t,{d:e}]),this.submitOp(o,n),o},_onOp:function(t,e){var n,o,i,s,r,c;if(!e){for(o=i=0,c=[],s=0,r=t.length;r>s;s++)switch(n=t[s],typeof n){case"number":o+=n,c.push(i+=n);break;case"string":this.emit("insert",o,n),c.push(o+=n.length);break;case"object":this.emit("remove",o,n.d),c.push(i+=n.d);break;default:c.push(void 0)}return c}}}}).call(this);