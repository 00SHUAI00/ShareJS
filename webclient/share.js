(function(){(function(){var t,e,n,i,o,r,s={exports:{}},p=s.exports;p.name="text",p.uri="http://sharejs.org/types/textv1",p.create=function(t){if(null!=t&&"string"!=typeof t)throw Error("Initial data must be a string");return t||""},t=function(t){var e,n,i,o;if(!Array.isArray(t))throw Error("Op must be an array of components");for(n=null,i=0,o=t.length;o>i;i++){switch(e=t[i],typeof e){case"object":if(!("number"==typeof e.d&&e.d>0))throw Error("Object components must be deletes of size > 0");break;case"string":if(!(e.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(e>0))throw Error("Skip components must be >0");if("number"==typeof n)throw Error("Adjacent skip components should be combined")}n=e}if("number"==typeof n)throw Error("Op has a trailing skip")},n=function(t){return function(e){return e&&0!==e.d?0===t.length?t.push(e):typeof e==typeof t[t.length-1]?"object"==typeof e?t[t.length-1].d+=e.d:t[t.length-1]+=e:t.push(e):void 0}},i=function(t){var e,n,i,o;return e=0,n=0,o=function(i,o){var r,s;return e===t.length?-1===i?null:i:(r=t[e],"number"==typeof r?-1===i||i>=r-n?(s=r-n,++e,n=0,s):(n+=i,i):"string"==typeof r?-1===i||"i"===o||i>=r.length-n?(s=r.slice(n),++e,n=0,s):(s=r.slice(n,n+i),n+=i,s):-1===i||"d"===o||i>=r.d-n?(s={d:r.d-n},++e,n=0,s):(n+=i,{d:i}))},i=function(){return t[e]},[o,i]},e=function(t){return"number"==typeof t?t:t.length||t.d},r=function(t){return t.length>0&&"number"==typeof t[t.length-1]&&t.pop(),t},p.normalize=function(t){var e,i,o,s,p;for(o=[],e=n(o),s=0,p=t.length;p>s;s++)i=t[s],e(i);return r(o)},p.apply=function(e,n){var i,o,r,s,p;if("string"!=typeof e)throw Error("Snapshot should be a string");for(t(n),r=0,o=[],s=0,p=n.length;p>s;s++)switch(i=n[s],typeof i){case"number":if(i>e.length)throw Error("The op is too long for this document");o.push(e.slice(0,i)),e=e.slice(i);break;case"string":o.push(i);break;case"object":e=e.slice(i.d)}return o.join("")+e},p.transform=function(o,s,p){var a,h,l,c,d,u,f,v,g,m,y;if("left"!==p&&"right"!==p)throw Error("side ("+p+") must be 'left' or 'right'");for(t(o),t(s),d=[],a=n(d),y=i(o),v=y[0],f=y[1],g=0,m=s.length;m>g;g++)switch(l=s[g],typeof l){case"number":for(c=l;c>0;)h=v(c,"i"),a(h),"string"!=typeof h&&(c-=e(h));break;case"string":"left"===p&&(u=f(),"string"==typeof u&&a(v(-1))),a(l.length);break;case"object":for(c=l.d;c>0;)switch(h=v(c,"i"),typeof h){case"number":c-=h;break;case"string":a(h);break;case"object":c-=h.d}}for(;l=v(-1);)a(l);return r(d)},p.compose=function(o,s){var p,a,h,l,c,d,u,f,v,g;for(t(o),t(s),c=[],p=n(c),g=i(o),d=g[0],u=g[1],f=0,v=s.length;v>f;f++)switch(h=s[f],typeof h){case"number":for(l=h;l>0;)a=d(l,"d"),p(a),"object"!=typeof a&&(l-=e(a));break;case"string":p(h);break;case"object":for(l=h.d;l>0;)switch(a=d(l,"d"),typeof a){case"number":p({d:a}),l-=a;break;case"string":l-=a.length;break;case"object":p(a)}}for(;h=d(-1);)p(h);return r(c)},o=function(t,e){var n,i,o,r;for(i=0,o=0,r=e.length;r>o&&(n=e[o],!(i>=t));o++)switch(typeof n){case"number":if(i+n>=t)return t;i+=n;break;case"string":i+=n.length,t+=n.length;break;case"object":t-=Math.min(n.d,t-i)}return t},p.transformCursor=function(t,e,n){var i,r,s,p;if(r=0,n){for(s=0,p=e.length;p>s;s++)switch(i=e[s],typeof i){case"number":r+=i;break;case"string":r+=i.length}return[r,r]}return[o(t[0],e),o(t[1],e)]};var a=window.ottypes=window.ottypes||{},h=s.exports;a[h.name]=h,h.uri&&(a[h.uri]=h)})();var t="undefined"==typeof window?require("ot-types"):window.ottypes;t["http://sharejs.org/types/textv1"].api={provides:{text:!0},getLength:function(){return this.getSnapshot().length},getText:function(){return this.getSnapshot()},insert:function(t,e,n){return this.submitOp([t,e],n)},remove:function(t,e,n){return this.submitOp([t,{d:e}],n)},_onOp:function(t){for(var e=0,n=0,i=0;t.length>i;i++){var o=t[i];switch(typeof o){case"number":e+=o,n+=o;break;case"string":this.onInsert&&this.onInsert(e,o),e+=o.length;break;case"object":this.onRemove&&this.onRemove(e,o.d),n+=o.d}}}},function(){var t={exports:{}},e=t.exports;e._bootstrapTransform=function(t,e,n,i){var o,r;return o=function(t,n,i,o){return e(i,t,n,"left"),e(o,n,t,"right")},t.transformX=t.transformX=r=function(t,e){var s,p,a,h,l,c,d,u,f,v,g,m,y,b,w,_,k,x,O;for(n(t),n(e),l=[],v=0,b=e.length;b>v;v++){for(f=e[v],h=[],s=0;t.length>s;){if(c=[],o(t[s],f,h,c),s++,1!==c.length){if(0===c.length){for(x=t.slice(s),g=0,w=x.length;w>g;g++)p=x[g],i(h,p);f=null;break}for(O=r(t.slice(s),c),a=O[0],u=O[1],m=0,_=a.length;_>m;m++)p=a[m],i(h,p);for(y=0,k=u.length;k>y;y++)d=u[y],i(l,d);f=null;break}f=c[0]}null!=f&&i(l,f),t=h}return[t,l]},t.transform=t.transform=function(t,n,i){if("left"!==i&&"right"!==i)throw Error("type must be 'left' or 'right'");return 0===n.length?t:1===t.length&&1===n.length?e([],t[0],n[0],i):"left"===i?r(t,n)[0]:r(n,t)[1]}};var n,i,o,r,s,p,a,h;p={name:"text-old",uri:"http://sharejs.org/types/textv0",create:function(){return""}},s=function(t,e,n){return t.slice(0,e)+n+t.slice(e)},i=function(t){var e,n;if("number"!=typeof t.p)throw Error("component missing position field");if(n=typeof t.i,e=typeof t.d,!("string"===n^"string"===e))throw Error("component needs an i or d field");if(!(t.p>=0))throw Error("position cannot be negative")},o=function(t){var e,n,o;for(n=0,o=t.length;o>n;n++)e=t[n],i(e);return!0},p.apply=function(t,e){var n,i,r,p;for(o(e),r=0,p=e.length;p>r;r++)if(n=e[r],null!=n.i)t=s(t,n.p,n.i);else{if(i=t.slice(n.p,n.p+n.d.length),n.d!==i)throw Error("Delete component '"+n.d+"' does not match deleted text '"+i+"'");t=t.slice(0,n.p)+t.slice(n.p+n.d.length)}return t},p._append=n=function(t,e){var n,i,o;return""!==e.i&&""!==e.d?0===t.length?t.push(e):(n=t[t.length-1],null!=n.i&&null!=e.i&&n.p<=(i=e.p)&&n.p+n.i.length>=i?t[t.length-1]={i:s(n.i,e.p-n.p,e.i),p:n.p}:null!=n.d&&null!=e.d&&e.p<=(o=n.p)&&e.p+e.d.length>=o?t[t.length-1]={d:s(e.d,n.p-e.p,n.d),p:e.p}:t.push(e)):void 0},p.compose=function(t,e){var i,r,s,p;for(o(t),o(e),r=t.slice(),s=0,p=e.length;p>s;s++)i=e[s],n(r,i);return r},p.compress=function(t){return p.compose([],t)},p.normalize=function(t){var e,i,o,r,s;for(i=[],(null!=t.i||null!=t.p)&&(t=[t]),o=0,r=t.length;r>o;o++)e=t[o],null==(s=e.p)&&(e.p=0),n(i,e);return i},h=function(t,e,n){return null!=e.i?t>e.p||e.p===t&&n?t+e.i.length:t:e.p>=t?t:e.p+e.d.length>=t?e.p:t-e.d.length},p.transformCursor=function(t,e,n){var i,o,r,s;for(o="right"===n,r=0,s=e.length;s>r;r++)i=e[r],t=h(t,i,o);return t},p._tc=a=function(t,e,i,r){var s,p,a,l,c,d;if(o([e]),o([i]),null!=e.i)n(t,{i:e.i,p:h(e.p,i,"right"===r)});else if(null!=i.i)d=e.d,e.p<i.p&&(n(t,{d:d.slice(0,i.p-e.p),p:e.p}),d=d.slice(i.p-e.p)),""!==d&&n(t,{d:d,p:e.p+i.i.length});else if(e.p>=i.p+i.d.length)n(t,{d:e.d,p:e.p-i.d.length});else if(e.p+e.d.length<=i.p)n(t,e);else{if(l={d:"",p:e.p},e.p<i.p&&(l.d=e.d.slice(0,i.p-e.p)),e.p+e.d.length>i.p+i.d.length&&(l.d+=e.d.slice(i.p+i.d.length-e.p)),a=Math.max(e.p,i.p),p=Math.min(e.p+e.d.length,i.p+i.d.length),s=e.d.slice(a-e.p,p-e.p),c=i.d.slice(a-i.p,p-i.p),s!==c)throw Error("Delete ops delete different text in the same region of the document");""!==l.d&&(l.p=h(l.p,i),n(t,l))}return t},r=function(t){return null!=t.i?{d:t.i,p:t.p}:{i:t.d,p:t.p}},p.invert=function(t){var e,n,i,o,s;for(o=t.slice().reverse(),s=[],n=0,i=o.length;i>n;n++)e=o[n],s.push(r(e));return s},"undefined"==typeof require?e._bootstrapTransform(p,p.transformComponent,p.checkValidOp,p.append):require("./helpers")._bootstrapTransform(p,p.transformComponent,p.checkValidOp,p.append),t.exports=p;var l=function(t){return"[object Array]"==Object.prototype.toString.call(t)},c=function(t){return JSON.parse(JSON.stringify(t))},p="undefined"!=typeof require?require("./text-old"):window.ottypes.text,d={name:"json0",uri:"http://sharejs.org/types/JSONv0"};d.create=function(t){return void 0===t?null:t},d.invertComponent=function(t){var e={p:t.p};return void 0!==t.si&&(e.sd=t.si),void 0!==t.sd&&(e.si=t.sd),void 0!==t.oi&&(e.od=t.oi),void 0!==t.od&&(e.oi=t.od),void 0!==t.li&&(e.ld=t.li),void 0!==t.ld&&(e.li=t.ld),void 0!==t.na&&(e.na=-t.na),void 0!==t.lm&&(e.lm=t.p[t.p.length-1],e.p=t.p.slice(0,t.p.length-1).concat([t.lm])),e},d.invert=function(t){for(var e=t.slice().reverse(),n=[],i=0;e.length>i;i++)n.push(d.invertComponent(e[i]));return n},d.checkValidOp=function(t){for(var e=0;t.length>e;e++)if(!l(t[e].p))throw Error("Missing path")},d.checkList=function(t){if(!l(t))throw Error("Referenced element not a list")},d.checkObj=function(t){if(t.constructor!==Object)throw Error("Referenced element not an object (it was "+JSON.stringify(t)+")")},d.apply=function(t,e){d.checkValidOp(e),e=c(e);for(var n={data:t},i=0;e.length>i;i++){for(var o=e[i],r=null,s=null,p=n,a="data",h=0;o.p.length>h;h++){var l=o.p[h];if(r=p,s=a,p=p[a],a=l,null==r)throw Error("Path invalid")}if(void 0!==o.na){if("number"!=typeof p[a])throw Error("Referenced element not a number");p[a]+=o.na}else if(void 0!==o.si){if("string"!=typeof p)throw Error("Referenced element not a string (it was "+JSON.stringify(p)+")");r[s]=p.slice(0,a)+o.si+p.slice(a)}else if(void 0!==o.sd){if("string"!=typeof p)throw Error("Referenced element not a string");if(p.slice(a,a+o.sd.length)!==o.sd)throw Error("Deleted string does not match");r[s]=p.slice(0,a)+p.slice(a+o.sd.length)}else if(void 0!==o.li&&void 0!==o.ld)d.checkList(p),p[a]=o.li;else if(void 0!==o.li)d.checkList(p),p.splice(a,0,o.li);else if(void 0!==o.ld)d.checkList(p),p.splice(a,1);else if(void 0!==o.lm){if(d.checkList(p),o.lm!=a){var u=p[a];p.splice(a,1),p.splice(o.lm,0,u)}}else if(void 0!==o.oi)d.checkObj(p),p[a]=o.oi;else{if(void 0===o.od)throw Error("invalid / missing instruction in op");d.checkObj(p),delete p[a]}}return n.data},d.incrementalApply=function(t,e,n){for(var i=0;e.length>i;i++){var o=[e[i]];t=d.apply(t,o),n(o,t)}return t},d.pathMatches=function(t,e,n){if(t.length!=e.length)return!1;for(var i=0;t.length>i;i++){var o=t[i];if(o!==e[i]&&(!n||i!==t.length-1))return!1}return!0},d.append=function(t,e){e=c(e);var n;0!=t.length&&d.pathMatches(e.p,(n=t[t.length-1]).p)?void 0!==n.na&&void 0!==e.na?t[t.length-1]={p:n.p,na:n.na+e.na}:void 0!==n.li&&void 0===e.li&&e.ld===n.li?void 0!==n.ld?delete n.li:t.pop():void 0!==n.od&&void 0===n.oi&&void 0!==e.oi&&void 0===e.od?n.oi=e.oi:void 0!==e.lm&&e.p[e.p.length-1]===e.lm||t.push(e):t.push(e)},d.compose=function(t,e){d.checkValidOp(t),d.checkValidOp(e);for(var n=c(t),i=0;e.length>i;i++)d.append(n,e[i]);return n},d.normalize=function(t){var e=[];t=l(t)?t:[t];for(var n=0;t.length>n;n++){var i=t[n];null==i.p&&(i.p=[]),d.append(e,i)}return e},d.canOpAffectOp=function(t,e){if(0===t.length)return!0;if(0===e.length)return!1;e=e.slice(0,e.length-1),t=t.slice(0,t.length-1);for(var n=0;t.length>n;n++){var i=t[n];if(n>=e.length)return!1;if(i!=e[n])return!1}return!0},d.transformComponent=function(t,e,n,i){e=c(e),void 0!==e.na&&e.p.push(0),void 0!==n.na&&n.p.push(0);var o;d.canOpAffectOp(n.p,e.p)&&(o=n.p.length-1);var r;d.canOpAffectOp(e.p,n.p)&&(r=e.p.length-1);var s=e.p.length,a=n.p.length;if(void 0!==e.na&&e.p.pop(),void 0!==n.na&&n.p.pop(),n.na){if(null!=r&&a>=s&&n.p[r]==e.p[r])if(void 0!==e.ld){var h=c(n);h.p=h.p.slice(s),e.ld=d.apply(c(e.ld),[h])}else if(void 0!==e.od){var h=c(n);h.p=h.p.slice(s),e.od=d.apply(c(e.od),[h])}return d.append(t,e),t}if(null!=r&&a>s&&e.p[r]==n.p[r])if(void 0!==e.ld){var h=c(n);h.p=h.p.slice(s),e.ld=d.apply(c(e.ld),[h])}else if(void 0!==e.od){var h=c(n);h.p=h.p.slice(s),e.od=d.apply(c(e.od),[h])}if(null!=o){var l=s==a;if(void 0!==n.na);else if(void 0!==n.si||void 0!==n.sd){if(void 0!==e.si||void 0!==e.sd){if(!l)throw Error("must be a string?");var u=function(t){var e={p:t.p[t.p.length-1]};return null!=t.si?e.i=t.si:e.d=t.sd,e},f=u(e),v=u(n),g=[];p._tc(g,f,v,i);for(var m=0;g.length>m;m++){var y=g[m],b={p:e.p.slice(0,o)};b.p.push(y.p),null!=y.i&&(b.si=y.i),null!=y.d&&(b.sd=y.d),d.append(t,b)}return t}}else if(void 0!==n.li&&void 0!==n.ld){if(n.p[o]===e.p[o]){if(!l)return t;if(void 0!==e.ld){if(void 0===e.li||"left"!==i)return t;e.ld=c(n.li)}}}else if(void 0!==n.li)void 0!==e.li&&void 0===e.ld&&l&&e.p[o]===n.p[o]?"right"===i&&e.p[o]++:n.p[o]<=e.p[o]&&e.p[o]++,void 0!==e.lm&&l&&n.p[o]<=e.lm&&e.lm++;else if(void 0!==n.ld){if(void 0!==e.lm&&l){if(n.p[o]===e.p[o])return t;var w=n.p[o],_=e.p[o],k=e.lm;(k>w||w===k&&k>_)&&e.lm--}if(n.p[o]<e.p[o])e.p[o]--;else if(n.p[o]===e.p[o]){if(s>a)return t;if(void 0!==e.ld){if(void 0===e.li)return t;delete e.ld}}}else if(void 0!==n.lm)if(void 0!==e.lm&&s===a){var _=e.p[o],k=e.lm,x=n.p[o],O=n.lm;if(x!==O)if(_===x){if("left"!==i)return t;e.p[o]=O,_===k&&(e.lm=O)}else _>x&&e.p[o]--,_>O?e.p[o]++:_===O&&x>O&&(e.p[o]++,_===k&&e.lm++),k>x?e.lm--:k===x&&k>_&&e.lm--,k>O?e.lm++:k===O&&(O>x&&k>_||x>O&&_>k?"right"===i&&e.lm++:k>_?e.lm++:k===x&&e.lm--)}else if(void 0!==e.li&&void 0===e.ld&&l){var _=n.p[o],k=n.lm;w=e.p[o],w>_&&e.p[o]--,w>k&&e.p[o]++}else{var _=n.p[o],k=n.lm;w=e.p[o],w===_?e.p[o]=k:(w>_&&e.p[o]--,w>k?e.p[o]++:w===k&&_>k&&e.p[o]++)}else if(void 0!==n.oi&&void 0!==n.od){if(e.p[o]===n.p[o]){if(void 0===e.oi||!l)return t;if("right"===i)return t;e.od=n.oi}}else if(void 0!==n.oi){if(void 0!==e.oi&&e.p[o]===n.p[o]){if("left"!==i)return t;d.append(t,{p:e.p,od:n.oi})}}else if(void 0!==n.od&&e.p[o]==n.p[o]){if(!l)return t;if(void 0===e.oi)return t;delete e.od}}return d.append(t,e),t},"undefined"!=typeof require?require("./helpers")._bootstrapTransform(d,d.transformComponent,d.checkValidOp,d.append):e._bootstrapTransform(d,d.transformComponent,d.checkValidOp,d.append),t.exports=d;var u=window.ottypes=window.ottypes||{},f=t.exports;u[f.name]=f,f.uri&&(u[f.uri]=f)}();var e=window.sharejs={version:"0.7.0"},n=function(){};n.prototype.on=function(t,e){var n=this._events=this._events||{};(n[t]=n[t]||[]).push(e)},n.prototype.removeListener=function(t,e){for(var n=this._events=this._events||{},i=n[t]=n[t]||[],o=0;i.length>o;)i[o]===e&&(i[o]=void 0),o++;setTimeout(function(){n[t]=[];for(var e,o=0;i.length>o;o++)(e=i[o])&&n[t].push(e)},0)},n.prototype.emit=function(t){var e=this._events,n=Array.prototype.splice.call(arguments,1);if(!e||!e[t])return"error"==t&&console&&console.error.apply(console,n),void 0;for(var i=e[t],o=0;i.length>o;o++)i[o]&&i[o].apply(this,n)},n.prototype.once=function(t,e){var n,i=this;this.on(t,n=function(){i.removeListener(t,n),e.apply(i,arguments)})},n.mixin=function(t){var e=t.prototype||t;return e.on=n.prototype.on,e.removeListener=n.prototype.removeListener,e.emit=n.prototype.emit,e.once=n.prototype.once,t},"undefined"==typeof window&&(module.exports=n);var i,n;"undefined"!=typeof require?(i=require("ot-types"),n=require("./microevent")):i=window.ottypes;var o=e.Doc=function(t,e,n,i){this.connection=t,this.collection=e,this.name=n,this.autoSubscribe=!1,this.ready=!1,this.provides={},this.inflightData=null,this.editingContexts=[],this.pendingData=[],i&&void 0!==i.snapshot&&this._injestData(i)};o.prototype.whenReady=function(t){this.ready?t():this.on("ready",t)},o.prototype._send=function(t){t.c=this.collection,t.doc=this.name,this.connection.send(t)},o.prototype.subscribe=function(){this.autoSubscribe=!0,this.connection.canSend&&this._send(this.ready?{a:"sub",v:this.version}:{a:"sub"})},o.prototype.unsubscribed=function(){this.autoSubscribe=!1,this.connection.canSend&&this._send({a:"unsub"})},o.prototype.fetch=function(){this._send({a:"fetch"})},o.prototype._onConnectionStateChanged=function(t){"connecting"===t&&(this.autoSubscribe&&this.subscribe(),this.inflightData&&this._sendOpData(this.inflightData))},o.prototype.createContext=function(){var t=this.type;if(!t)throw Error("Missing type");var e=this,n={getSnapshot:function(){return e.snapshot},submitOp:function(t,i){e.submitOp(t,n,i)},destroy:function(){this.detach&&(this.detach(),delete this.detach),delete this._onOp,this.remove=!0}};if(t.api)for(k in t.api)n[k]=t.api[k];else n.provides={};return this.editingContexts.push(n),n},o.prototype.removeContexts=function(){if(this.editingContexts)for(var t=0;this.editingContexts.length>t;t++)this.editingContexts[t].destroy();this.editingContexts.length=0},o.prototype._setType=function(t){if("string"==typeof t){if(!i[t])throw Error("Missing type "+t);t=i[t]}this.removeContexts(),this.type=t,t?t.api&&(this.provides=t.api.provides):(delete this.snapshot,this.provides={})},o.prototype._injestData=function(t){if("number"!=typeof t.v)throw Error("Missing version in injested data");return"number"==typeof this.version?("undefined"!=typeof console&&console.warn("Ignoring extra attempt to injest data"),void 0):(this.version=t.v,this.snapshot=t.snapshot,this._setType(t.type),this.ready=!0,this.emit("ready"),void 0)};var r=function(t){delete t.op,delete t.create,delete t.del};o.prototype._xf=function(t,e){if(e.create||e.del)return r(t);if(t.del)return r(e);if(t.create)throw Error("Invalid state. This is a bug. Please file an issue on github");if(e.op&&t.op)if(t.type.transformX){var n=t.type.transformX(t.op,e.op);t.op=n[0],e.op=n[1]}else t.op=t.type.transform(t.op,e.op,"left"),e.op=t.type.transform(e.op,t.op,"right")},o.prototype._otApply=function(t,e){this.locked=!0;var n=this.type;if(t.create){var i=t.create;this._setType(i.type),this.snapshot=n.create(i.data),this.once("unlocked",function(){this.emit("created",e)})}else if(t.del)this._setType(null),this.once("unlocked",function(){this.emit("deleted",e)});else if(t.op){if(!n)throw Error("Document does not exist");var o=t.op;if(this.emit("before op",o,e),this.incremental&&n.incrementalApply){var r=this;n.incrementalApply(this.snapshot,o,function(t,n){r.snapshot=n,r.emit("op",t,e)})}else this.snapshot=n.apply(this.snapshot,o),this.emit("op",o,e)}},o.prototype._afterOtApply=function(t,e){if(this.locked=!1,this.emit("unlocked"),t.op){var n=this.editingContexts;if(n){for(var i=0;n.length>i;i++){var o=n[i];e!=o&&o._onOp&&o._onOp(t.op)}for(var i=0;n.length>i;i++)n.remove&&n.splice(i--,1)}return this.emit("after op",t.op,e)}},o.prototype._sendOpData=function(t){var e={a:"op",v:this.version};t.src&&(e.src=t.src,e.seq=t.seq),t.op&&(e.op=t.op),t.create&&(e.create=t.create),t.del&&(e.del=t.del),this._send(e),t.src||(t.src=this.connection.id,t.seq=this.connection.seq++)},o.prototype._submitOpData=function(t,e,n){"function"==typeof e&&(n=e,e=!0),null==e&&(e=!0);var i=function(t){n?n(t):console&&console.warn("Failed attempt to submitOp:",t)};if(!this.ready)return i("You cannot currently submit operations to an unsubscribed document");if(this.locked)return i("Cannot call submitOp from inside an 'op' event handler");if(t.op){if(!this.type)return i("Document has not been created");this.type.normalize&&(t.op=this.type.normalize(t.op))}this._otApply(t,e);var o;t.op&&this.pendingData.length&&(o=this.pendingData[this.pendingData.length-1]).op&&this.type.compose?o.op=this.type.compose(o.op,t.op):(o=t,t.type=this.type,t.callbacks=[],this.pendingData.push(t)),n&&o.callbacks.push(n),this._afterOtApply(t,e);var r=this;setTimeout(function(){r.flush()},0)},o.prototype.submitOp=function(t,e,n){this._submitOpData({op:t},e,n)},o.prototype.create=function(t,e,n,i){return"function"==typeof e&&(n=e,e=void 0),this.type?(i&&i("Document already exists"),void 0):(this._submitOpData({create:{type:t,data:e}},n,i),void 0)},o.prototype.del=function(t,e){return this.type?(this._submitOpData({del:!0},t,e),void 0):(e&&e("Document does not exist"),void 0)},o.prototype._tryRollback=function(t){if(t.create)return this._setType(null);if(t.op&&t.type.invert){for(var e=t.type.invert(t.op),n=0;this.pendingData.length>n;n++)this._xf(this.pendingData[n],e);this._otApply(e,!1),this._afterOtApply(e,!1)}else this._setType(null),this.v=null,this.ready=!1,this.emit("error","Op apply failed and the operation could not be reverted"),this.fetch()},o.prototype._opAcknowledged=function(t){if("Op already submitted"!==t.error){var e=this.inflightData;if(this.inflightData=null,t.error)this._tryRollback(e);else{if(t.v!==this.version)throw Error("Invalid version from server. Please file an issue, this is a bug.");this.version++,this.emit("acknowledged",e)}for(var n=0;e.callbacks>n;n++)e.callbacks[n](t.error);this.flush()}},o.prototype._onMessage=function(t){if(t.c!==this.collection||t.doc!==this.name)throw Error("Got message for wrong document.");switch(t.a){case"data":this._injestData(t),this.emit("fetched",this.snapshot);break;case"sub":t.error?(console&&console.error("Could not open document: "+t.error),this.emit("error",t.error),this.autoSubscribe=!1):(this.subscribed=!0,this.flush()),this.emit("subscribed",t.error);break;case"unsub":this.subscribed=!1,this.emit("unsubscribed");break;case"ack":t.error&&this._opAcknowledged(t);break;case"op":if(this.inflightData&&t.src===this.inflightData.src&&t.seq===this.inflightData.seq){this._opAcknowledged(t);break}if(t.v!==this.version){this.emit("error","Expected version "+this.version+" but got "+t.v);break}this.inflightData&&this._xf(this.inflightData,t);for(var e=0;this.pendingData.length>e;e++)this._xf(this.pendingData[e],t);this.version++,this._otApply(t,!1),this._afterOtApply(t,!1);break;case"meta":console&&console.warn("Unhandled meta op:",t);break;default:console&&console.warn("Unhandled document message:",t)}},o.prototype.flush=function(){this.connection.canSend&&!this.inflightData&&0!=this.pendingData.length&&(this.inflightData=this.pendingData.shift(),this._sendOpData(this.inflightData))},o.prototype.getSnapshot=function(){return this.snapshot},n.mixin(o);var i,o;"undefined"!=typeof require?(i=require("ot-types"),o=require("./doc").Doc):(i=window.ottypes,o=e.Doc);var s=e.Connection=function(t){this.socket=t,this.collections={},this.nextQueryId=1,this.queries={},this.state="disconnected",this.canSend=!1,this.reset();var e=this;t.onmessage=function(t){switch(console.log("RECV",t),t.a){case"init":if(0!==t.protocol)throw Error("Invalid protocol version");if("string"!=typeof t.id)throw Error("Invalid client id");e.id=t.id,e._setState("connected");break;case"qsub":case"q":case"qunsub":e.queries[t.id]._onMessage(t);break;default:var n,i,o;if(t.doc?(n=this._lastReceivedCollection=t.c,i=this._lastReceivedDoc=t.doc):(n=t.c=this._lastReceivedCollection,i=t.doc=this._lastReceivedDoc),o=e.get(n,i),!o){console&&console.error("Message for unknown doc. Ignoring.",t);break}o._onMessage(t)}},t.onopen=function(){e._setState("connecting")},t.onerror=function(t){e.emit("error",t)},t.onclose=function(t){e._setState("disconnected",t),("Closed"===t||"Stopped by server"===t)&&e._setState("stopped",t)}};s.prototype.reset=function(){this.id=this.lastError=this._lastReceivedCollection=this._lastReceivedDoc=this._lastSentCollection=this._lastSentDoc=null,this.seq=1},s.prototype._setState=function(t,e){if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state||"connected"===t&&"connecting"!==this.state)throw Error("Cannot transition directly from "+this.state+" to "+t);this.state=t,this.canSend="connecting"===t||"connected"===t,"disconnected"===t&&this.reset(),this.emit(t,e);for(c in this.collections){var n=this.collections[c];for(docName in n)n[docName]._onConnectionStateChanged(t,e)}for(c in this.queries)this.queries[c]._onConnectionStateChanged(t,e)}},s.prototype.send=function(t){if(console.log("SEND:",t),t.doc){var e=t.doc,n=t.c;n===this._lastSentCollection&&e===this._lastSentDoc?(delete t.c,delete t.doc):(this._lastSentCollection=n,this._lastSentDoc=e)}this.socket.send(t)},s.prototype.disconnect=function(){this.socket.close()},s.prototype.get=function(t,e){return this.collections[t]?this.collections[t][e]:void 0},s.prototype.getOrCreate=function(t,e,n){var i=this.get(t,e);return i?i:(i=new o(this,t,e,n),t=this.collections[t]=this.collections[t]||{},t[e]=i)},s.prototype.createQuery=function(t,e){var n=this.nextQueryId++,i=new a(this,n,t,e);return this.queries[n]=i,i},s.prototype.destroyQuery=function(t){delete this.queries[t.id]},"undefined"!=typeof require&&(n=require("./microevent")),n.mixin(s);var p=function(t,e,n){if(e!==n){for(var i=0;e.charAt(i)===n.charAt(i);)i++;for(var o=0;e.charAt(e.length-1-o)===n.charAt(n.length-1-o)&&e.length>o+i&&n.length>o+i;)o++;e.length!==i+o&&t.remove(i,e.length-i-o),n.length!==i+o&&t.insert(i,n.slice(i,n.length-o))}};window.sharejs.Doc.prototype.attachTextarea=function(t,e){if(e||(e=this.createContext()),!e.provides.text)throw Error("Cannot attach to non-text document");t.value=e.getText();var n,i=function(e,i){if(i)var o=[i(t.selectionStart),i(t.selectionEnd)];var r=t.scrollTop;t.value=e,n=t.value,t.scrollTop!==r&&(t.scrollTop=r),o&&window.document.activeElement===t&&(t.selectionStart=o[0],t.selectionEnd=o[1])};i(e.getText()),e.onInsert=function(e,n){var o=function(t){return t>e?t+n.length:t},r=t.value.replace(/\r\n/g,"\n");i(r.slice(0,e)+n+r.slice(e),o)},e.onRemove=function(e,n){var o=function(t){return t>e?t-Math.min(n,t-e):t},r=t.value.replace(/\r\n/g,"\n");i(r.slice(0,e)+r.slice(e+n),o)};for(var o=function(){setTimeout(function(){t.value!==n&&(n=t.value,p(e,e.getText(),t.value.replace(/\r\n/g,"\n")))},0)},r=["textInput","keydown","keyup","select","cut","paste"],s=0;r.length>s;s++){var a=r[s];t.addEventListener?t.addEventListener(a,o,!1):t.attachEvent("on"+a,o)}return e.detach=function(){for(var e=0;r.length>e;e++){var n=r[e];t.removeEventListener?t.removeEventListener(n,o,!1):t.detachEvent("on"+n,o)}},e};var a=function(t,e,n,i){this.connection=t,this.id=e,this.collection=n,this.query=i,this.results=[],this.autoFetch=!1,this.autoSubscribe=!1,this.ready=!1};a.prototype.whenReady=function(t){this.ready?t():this.once("ready",t)},a.prototype._onMessage=function(t){if(t.error)return this.emit("error",t.error);if(t.data){for(var e=0;this.results.length>e;e++)this.emit("removed",this.results[e],0);this.results.length=0;for(var e=0;t.data.length>e;e++){var n=t.data[e],i=this.connection.getOrCreate(this.collection,n.docName,n);this.results.push(i),this.emit("added",i,e)}this.ready||(this.ready=!0,this.emit("ready",this.results))}else if(t.add){var o=t.add,i=this.connection.getOrCreate(this.collection,o.docName,o);this.results.splice(t.idx,0,i),this.emit("added",i,t.idx)}else t.rm&&(this.emit("removed",this.results[t.idx],t.idx),this.results.splice(t.idx,1))},a.prototype.subscribe=function(){this.autoSubscribe=!0,this.connection.canSend&&this.connection.send({a:"qsub",c:this.collection,o:{f:this.autoFetch,p:this.poll},id:this.id,q:this.query})},a.prototype.unsubscribe=function(){this.autoSubscribe=!1,this.connection.canSend&&this.connection.send({a:"qunsub",id:this.id})},a.prototype.destroy=function(){this.connection.destroyQuery(this)},a.prototype._onConnectionStateChanged=function(){"connecting"===this.connection.state&&this.autoSubscribe&&this.subscribe()},n.mixin(a);var h,l,d,u,f,v,t,g=[].slice;t="undefined"==typeof window?require("ot-types"):window.ottypes,d=e.extendDoc,e.extendDoc=function(t,e){return h.prototype[t]=e,d(t,e)},l=function(t){return 1===t.length&&t[0].constructor===Array?t[0]:t},h=function(){function t(t,e){this.doc=t,this.path=e}return t.prototype.at=function(){var t;return t=arguments.length>=1?g.call(arguments,0):[],this.doc.at(this.path.concat(l(t)))},t.prototype.parent=function(){return this.path.length?this.doc.at(this.path.slice(0,this.path.length-1)):void 0},t.prototype.get=function(){return this.doc.getAt(this.path)},t.prototype.set=function(t,e){return this.doc.setAt(this.path,t,e)},t.prototype.insert=function(t,e,n){return this.doc.insertAt(this.path,t,e,n)},t.prototype.del=function(t,e,n){return this.doc.deleteTextAt(this.path,e,t,n)},t.prototype.remove=function(t){return this.doc.removeAt(this.path,t)},t.prototype.push=function(t,e){return this.insert(this.get().length,t,e)},t.prototype.move=function(t,e,n){return this.doc.moveAt(this.path,t,e,n)},t.prototype.add=function(t,e){return this.doc.addAt(this.path,t,e)},t.prototype.on=function(t,e){return this.doc.addListener(this.path,t,e)},t.prototype.removeListener=function(t){return this.doc.removeListener(t)},t.prototype.getLength=function(){return this.get().length},t.prototype.getText=function(){return this.get()},t}(),f=function(t,e){var n,i,o,r,s,p;for(n={data:t},o="data",i=n,s=0,p=e.length;p>s;s++)if(r=e[s],i=i[o],o=r,i===void 0)throw Error("bad path");return{elem:i,key:o}},u=function(t,e){var n,i,o,r;if(t.length!==e.length)return!1;for(i=o=0,r=t.length;r>o;i=++o)if(n=t[i],n!==e[i])return!1;return!0},v=t["http://sharejs.org/types/JSONv0"],v.api={provides:{json:!0},_fixComponentPaths:function(t){var e,n,i,o,r,s,p,a,h,l,c;if(this._listeners&&void 0===t.na&&void 0===t.si&&void 0===t.sd){for(o=[],l=this._listeners,n=s=0,a=l.length;a>s;n=++s)if(i=l[n],e={p:i.path,na:0},r=v.transformComponent([],e,t,"left"),0===r.length)o.push(n);else{if(1!==r.length)throw Error("Bad assumption in json-api: xforming an 'na' op will always result in 0 or 1 components.");i.path=r[0].p}for(o.sort(function(t,e){return e-t}),c=[],p=0,h=o.length;h>p;p++)n=o[p],c.push(this._listeners.splice(n,1));return c}},_fixPaths:function(t){var e,n,i,o;for(o=[],n=0,i=t.length;i>n;n++)e=t[n],o.push(this._fixComponentPaths(e));return o},_submit:function(t,e){return this._fixPaths(t),this.submitOp(t,e)},at:function(){var t;return t=arguments.length>=1?g.call(arguments,0):[],new h(this,l(t))},get:function(){return this.snapshot},set:function(t,e){return this.setAt([],t,e)},getAt:function(t){var e,n,i;return i=f(this.snapshot,t),e=i.elem,n=i.key,e[n]},setAt:function(t,e,n){var i,o,r,s;if(s=f(this.snapshot,t),i=s.elem,o=s.key,r={p:t},i.constructor===Array)r.li=e,i[o]!==void 0&&(r.ld=i[o]);else{if("object"!=typeof i)throw Error("bad path");r.oi=e,i[o]!==void 0&&(r.od=i[o])}return this._submit([r],n)},removeAt:function(t,e){var n,i,o,r;if(r=f(this.snapshot,t),n=r.elem,i=r.key,n[i]===void 0)throw Error("no element at that path");if(o={p:t},n.constructor===Array)o.ld=n[i];else{if("object"!=typeof n)throw Error("bad path");o.od=n[i]}return this._submit([o],e)},insertAt:function(t,e,n,i){var o,r,s,p;return p=f(this.snapshot,t),o=p.elem,r=p.key,s={p:t.concat(e)},o[r].constructor===Array?s.li=n:"string"==typeof o[r]&&(s.si=n),this._submit([s],i)},moveAt:function(t,e,n,i){var o;return o=[{p:t.concat(e),lm:n}],this._submit(o,i)},addAt:function(t,e,n){var i;return i=[{p:t,na:e}],this._submit(i,n)},deleteTextAt:function(t,e,n,i){var o,r,s,p;return p=f(this.snapshot,t),o=p.elem,r=p.key,s=[{p:t.concat(n),sd:o[r].slice(n,n+e)}],this._submit(s,i)},addListener:function(t,e,n){var i;return this._listeners||(this._listeners=[]),i={path:t,event:e,cb:n},this._listeners.push(i),i},removeListener:function(t){var e;if(this._listeners)return e=this._listeners.indexOf(t),0>e?!1:(this._listeners.splice(e,1),!0)},_onOp:function(t){var e,n,i,o,r,s,p,a,h;for(h=[],p=0,a=t.length;a>p;p++)e=t[p],this._fixComponentPaths(e),r=void 0===e.na?e.p.slice(0,e.p.length-1):e.p,h.push(function(){var t,p,a,h,l;for(a=this._listeners,l=[],t=0,p=a.length;p>t;t++)if(h=a[t],s=h.path,o=h.event,n=h.cb,u(s,r))switch(o){case"insert":void 0!==e.li&&void 0===e.ld?l.push(n(e.p[e.p.length-1],e.li)):void 0!==e.oi&&void 0===e.od?l.push(n(e.p[e.p.length-1],e.oi)):void 0!==e.si?l.push(n(e.p[e.p.length-1],e.si)):l.push(void 0);break;case"delete":void 0===e.li&&void 0!==e.ld?l.push(n(e.p[e.p.length-1],e.ld)):void 0===e.oi&&void 0!==e.od?l.push(n(e.p[e.p.length-1],e.od)):void 0!==e.sd?l.push(n(e.p[e.p.length-1],e.sd)):l.push(void 0);break;case"replace":void 0!==e.li&&void 0!==e.ld?l.push(n(e.p[e.p.length-1],e.ld,e.li)):void 0!==e.oi&&void 0!==e.od?l.push(n(e.p[e.p.length-1],e.od,e.oi)):l.push(void 0);break;case"move":void 0!==e.lm?l.push(n(e.p[e.p.length-1],e.lm)):l.push(void 0);break;case"add":void 0!==e.na?l.push(n(e.na)):l.push(void 0);break;default:l.push(void 0)}else v.canOpAffectOp(s,r)?"child op"===o?(i=e.p.slice(s.length),l.push(n(i,e))):l.push(void 0):l.push(void 0);return l}.call(this));return h}}})();