(function(){(function(){var t,e,n,o,i,r,s={exports:{}},a=s.exports;a.name="text",a.uri="http://sharejs.org/types/textv1",a.create=function(t){if(null!=t&&"string"!=typeof t)throw Error("Initial data must be a string");return t||""},t=function(t){var e,n,o,i;if(!Array.isArray(t))throw Error("Op must be an array of components");for(n=null,o=0,i=t.length;i>o;o++){switch(e=t[o],typeof e){case"object":if(!("number"==typeof e.d&&e.d>0))throw Error("Object components must be deletes of size > 0");break;case"string":if(!(e.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(e>0))throw Error("Skip components must be >0");if("number"==typeof n)throw Error("Adjacent skip components should be combined")}n=e}if("number"==typeof n)throw Error("Op has a trailing skip")},n=function(t){return function(e){return e&&0!==e.d?0===t.length?t.push(e):typeof e==typeof t[t.length-1]?"object"==typeof e?t[t.length-1].d+=e.d:t[t.length-1]+=e:t.push(e):void 0}},o=function(t){var e,n,o,i;return e=0,n=0,i=function(o,i){var r,s;return e===t.length?-1===o?null:o:(r=t[e],"number"==typeof r?-1===o||o>=r-n?(s=r-n,++e,n=0,s):(n+=o,o):"string"==typeof r?-1===o||"i"===i||o>=r.length-n?(s=r.slice(n),++e,n=0,s):(s=r.slice(n,n+o),n+=o,s):-1===o||"d"===i||o>=r.d-n?(s={d:r.d-n},++e,n=0,s):(n+=o,{d:o}))},o=function(){return t[e]},[i,o]},e=function(t){return"number"==typeof t?t:t.length||t.d},r=function(t){return t.length>0&&"number"==typeof t[t.length-1]&&t.pop(),t},a.normalize=function(t){var e,o,i,s,a;for(i=[],e=n(i),s=0,a=t.length;a>s;s++)o=t[s],e(o);return r(i)},a.apply=function(e,n){var o,i,r,s,a;if("string"!=typeof e)throw Error("Snapshot should be a string");for(t(n),r=0,i=[],s=0,a=n.length;a>s;s++)switch(o=n[s],typeof o){case"number":if(o>e.length)throw Error("The op is too long for this document");i.push(e.slice(0,o)),e=e.slice(o);break;case"string":i.push(o);break;case"object":e=e.slice(o.d)}return i.join("")+e},a.transform=function(i,s,a){var c,h,p,u,l,d,f,y,v,g,m;if("left"!==a&&"right"!==a)throw Error("side ("+a+") must be 'left' or 'right'");for(t(i),t(s),l=[],c=n(l),m=o(i),y=m[0],f=m[1],v=0,g=s.length;g>v;v++)switch(p=s[v],typeof p){case"number":for(u=p;u>0;)h=y(u,"i"),c(h),"string"!=typeof h&&(u-=e(h));break;case"string":"left"===a&&(d=f(),"string"==typeof d&&c(y(-1))),c(p.length);break;case"object":for(u=p.d;u>0;)switch(h=y(u,"i"),typeof h){case"number":u-=h;break;case"string":c(h);break;case"object":u-=h.d}}for(;p=y(-1);)c(p);return r(l)},a.compose=function(i,s){var a,c,h,p,u,l,d,f,y,v;for(t(i),t(s),u=[],a=n(u),v=o(i),l=v[0],d=v[1],f=0,y=s.length;y>f;f++)switch(h=s[f],typeof h){case"number":for(p=h;p>0;)c=l(p,"d"),a(c),"object"!=typeof c&&(p-=e(c));break;case"string":a(h);break;case"object":for(p=h.d;p>0;)switch(c=l(p,"d"),typeof c){case"number":a({d:c}),p-=c;break;case"string":p-=c.length;break;case"object":a(c)}}for(;h=l(-1);)a(h);return r(u)},i=function(t,e){var n,o,i,r;for(o=0,i=0,r=e.length;r>i&&(n=e[i],!(o>=t));i++)switch(typeof n){case"number":if(o+n>=t)return t;o+=n;break;case"string":o+=n.length,t+=n.length;break;case"object":t-=Math.min(n.d,t-o)}return t},a.transformCursor=function(t,e,n){var o,r,s,a;if(r=0,n){for(s=0,a=e.length;a>s;s++)switch(o=e[s],typeof o){case"number":r+=o;break;case"string":r+=o.length}return[r,r]}return[i(t[0],e),i(t[1],e)]};var c=window.ottypes=window.ottypes||{},h=s.exports;c[h.name]=h,h.uri&&(c[h.uri]=h)})();var t="undefined"==typeof window?require("ot-types"):window.ottypes;t["http://sharejs.org/types/textv1"].api={provides:{text:!0},getLength:function(){return this.getSnapshot().length},getText:function(){return this.getSnapshot()},insert:function(t,e,n){return this.submitOp([t,e],n)},remove:function(t,e,n){return this.submitOp([t,{d:e}],n)},_onOp:function(t){for(var e=0,n=0,o=0;t.length>o;o++){var i=t[o];switch(typeof i){case"number":e+=i,n+=i;break;case"string":this.onInsert&&this.onInsert(e,i),e+=i.length;break;case"object":this.onRemove&&this.onRemove(e,i.d),n+=i.d}}}};var e=window.sharejs={version:"0.7.0"},n=function(){};n.prototype.on=function(t,e){var n=this._events=this._events||{};(n[t]=n[t]||[]).push(e)},n.prototype.removeListener=function(t,e){for(var n=this._events=this._events||{},o=n[t]=n[t]||[],i=0;o.length>i;)o[i]===e&&(o[i]=void 0),i++;setTimeout(function(){n[t]=[];for(var e,i=0;o.length>i;i++)(e=o[i])&&n[t].push(e)},0)},n.prototype.emit=function(t){var e=this._events,n=Array.prototype.splice.call(arguments,1);if(!e||!e[t])return"error"==t&&console&&console.error.apply(console,n),void 0;var o=e[t];for(i=0;o.length>i;i++)o[i]&&o[i].apply(this,n)},n.prototype.once=function(t,e){var n,o=this;this.on(t,n=function(){o.removeListener(t,n),e.apply(o,arguments)})},n.mixin=function(t){var e=t.prototype||t;return e.on=n.prototype.on,e.removeListener=n.prototype.removeListener,e.emit=n.prototype.emit,e.once=n.prototype.once,t},"undefined"==typeof window&&(module.exports=n);var o,n;"undefined"==typeof window?(o=require("ot-types"),n=require("./microevent")):o=window.ottypes;var r=e.Doc=function(t,e,n,o){this.connection=t,this.collection=e,this.name=n,this.autoConnect=!1,this.ready=!1,this.provides={},this.inflightData=null,this.pendingData=[],o&&void 0!==o.snapshot&&this._injestData(o)};r.prototype.whenReady=function(t){this.ready?t():this.on("ready",t)},r.prototype._send=function(t){t.c=this.collection,t.doc=this.name,this.connection.send(t)},r.prototype.subscribe=function(){this.autoConnect=!0,this.connection.canSend&&this._send(this.ready?{a:"fetchsub",v:this.version}:{a:"sub"})},r.prototype.unsubscribed=function(){this.autoConnect=!1,this.connection.canSend&&this._send({a:"unsub"})},r.prototype.fetch=function(){this._send({a:"fetch"})},r.prototype._connectionStateChanged=function(t){"connecting"===t&&(this.autoConnect&&this.subscribe(),this.inflightData&&this._sendOpData(this.inflightData))},r.prototype.createEditingContext=function(){var t=this.type;if(!t||!t.api)throw Error("Missing type API");var e=this,n={getSnapshot:function(){return e.snapshot},submitOp:function(t,o){e.submitOp(t,n,o)}};for(k in t.api)n[k]=t.api[k];return this.editingContexts.push(n),n},r.prototype._setType=function(t){if("string"==typeof t){if(!o[t])throw Error("Missing type "+t);t=o[t]}this.type=t,t?t.api&&(this.provides=t.api.provides,this.editingContexts=[]):(delete this.snapshot,this.provides={},delete this.editingContexts)},r.prototype._injestData=function(t){if("number"!=typeof t.v)throw Error("Missing version in injested data");return"number"==typeof this.version?("undefined"!=typeof console&&console.warn("Ignoring extra attempt to injest data"),void 0):(this.version=t.v,this.snapshot=t.snapshot,this._setType(t.type),this.ready=!0,this.emit("ready"),void 0)};var s=function(t){delete t.op,delete t.create,delete t.del};r.prototype._xf=function(t,e){if(e.create||e.del)return s(t);if(t.del)return s(e);if(t.create)throw Error("Invalid state. This is a bug. Please file an issue on github");if(e.op&&t.op)if(t.type.transformX){var n=t.type.transformX(t.op,e.op);t.op=n[0],e.op=n[1]}else t.op=t.type.transform(t.op,e.op,"left"),e.op=t.type.transform(e.op,t.op,"right")},r.prototype._otApply=function(t,e){this.locked=!0;var n=this.type;if(t.create){var o=t.create;this._setType(o.type),this.snapshot=n.create(o.data),this.once("unlocked",function(){this.emit("created",e)})}else if(t.del)this._setType(null),this.once("unlocked",function(){this.emit("deleted",e)});else if(t.op){if(!n)throw Error("Document does not exist");var i=t.op;if(this.emit("before op",i,e),this.incremental&&n.incrementalApply){var r=this;n.incrementalApply(this.snapshot,i,function(t,n){r.snapshot=n,r.emit("op",t,e)})}else this.snapshot=n.apply(this.snapshot,i),this.emit("op",i,e)}},r.prototype._afterOtApply=function(t,e){if(this.locked=!1,this.emit("unlocked"),t.op){if(this.editingContexts)for(var n=0;this.editingContexts.length>n;n++){var o=this.editingContexts[n];e!=o&&o._onOp&&o._onOp(t.op)}return this.emit("after op",t.op,e)}},r.prototype._sendOpData=function(t){var e={a:"op",v:this.version};t.src&&(e.src=t.src,e.seq=t.seq),t.op&&(e.op=t.op),t.create&&(e.create=t.create),t.del&&(e.del=t.del),this._send(e),t.src||(t.src=this.connection.id,t.seq=this.connection.seq++)},r.prototype._submitOpData=function(t,e,n){"function"==typeof e&&(n=e,e=!0),null==e&&(e=!0);var o=function(t){n?n(t):console&&console.warn("Failed attempt to submitOp:",t)};if(!this.subscribed)return o("You cannot currently submit operations to an unsubscribed document");if(this.locked)return o("Cannot call submitOp from inside an 'op' event handler");if(t.op){if(!this.type)return o("Document has not been created");this.type.normalize&&(t.op=this.type.normalize(t.op))}this._otApply(t,e);var i;t.op&&this.pendingData.length&&(i=this.pendingData[this.pendingData.length-1]).op&&this.type.compose?i.op=this.type.compose(i.op,t.op):(i=t,t.type=this.type,t.callbacks=[],this.pendingData.push(t)),n&&i.callbacks.push(n),this._afterOtApply(t,e);var r=this;setTimeout(function(){r.flush()},0)},r.prototype.submitOp=function(t,e,n){this._submitOpData({op:t},e,n)},r.prototype.create=function(t,e,n,o){return"function"==typeof e&&(n=e,e=void 0),this.type?(o&&o("Document already exists"),void 0):(this._submitOpData({create:{type:t,data:e}},n,o),void 0)},r.prototype.del=function(t,e){return this.type?(this._submitOpData({del:!0},t,e),void 0):(e&&e("Document does not exist"),void 0)},r.prototype._tryRollback=function(t){if(t.create)return this._setType(null);if(t.op&&t.type.invert){for(var e=t.type.invert(t.op),n=0;this.pendingData.length>n;n++)this._xf(this.pendingData[n],e);this._otApply(e,!1),this._afterOtApply(e,!1)}else this._setType(null),this.v=null,this.ready=!1,this.emit("error","Op apply failed and the operation could not be reverted"),this.fetch()},r.prototype._opAcknowledged=function(t){if("Op already submitted"!==t.error){var e=this.inflightData;if(this.inflightData=null,t.error)this._tryRollback(e);else{if(t.v!==this.version)throw Error("Invalid version from server. Please file an issue, this is a bug.");this.version++,this.emit("acknowledged",e)}for(var n=0;e.callbacks>n;n++)e.callbacks[n](t.error);this.flush()}},r.prototype._onMessage=function(t){if(t.c!==this.collection||t.doc!==this.name)throw Error("Got message for wrong document.");switch(t.a){case"data":this._injestData(t),this.emit("fetched",this.snapshot);break;case"sub":t.error?(console&&console.error("Could not open document: "+t.error),this.emit("error",t.error),this.autoConnect=!1):(this.subscribed=!0,this.flush()),this.emit("subscribed",t.error);break;case"unsub":this.subscribed=!1,this.emit("unsubscribed");break;case"ack":t.error&&this._opAcknowledged(t);break;case"op":if(this.inflightData&&t.src===this.inflightData.src&&t.seq===this.inflightData.seq){this._opAcknowledged(t);break}if(t.v!==this.version){this.emit("error","Expected version "+this.version+" but got "+t.v);break}this.inflightData&&this._xf(this.inflightData,t);for(var e=0;this.pendingData>e;e++)this._xf(this.pendingData[e],t);this.version++,this._otApply(t,!1),this._afterOtApply(t,!1);break;case"meta":console&&console.warn("Unhandled meta op:",t);break;default:console&&console.warn("Unhandled document message:",t)}},r.prototype.flush=function(){this.connection.canSend&&!this.inflightData&&0!=this.pendingData.length&&(this.inflightData=this.pendingData.shift(),this._sendOpData(this.inflightData))},r.prototype.getSnapshot=function(){return this.snapshot},n.mixin(r);var a,r,n,c;"undefined"==typeof window&&(c=require("ot-types"),r=require("./doc").Doc),a=function(){function t(t){var e=this;this.socket=t,this.collections={},this.nextQueryId=1,this.queries={},this.state="disconnected",this.socket.onmessage=function(t){var n,o,i;switch(console.log("RECV",t),t.a){case"init":if(0!==t.protocol)throw Error("Invalid protocol version");if("string"!=typeof t.id)throw Error("Invalid client id");return e.id=t.id,e.setState("connected");case"q":return e.queries[t.id].onmessage(t);default:return void 0!==t.doc?(n=e.lastReceivedCollection=t.c,i=e.lastReceivedDoc=t.doc):(n=t.c=e.lastReceivedCollection,i=t.doc=e.lastReceivedDoc),(o=e.get(n,i))?o._onMessage(t):"undefined"!=typeof console&&null!==console?console.error("Unhandled message",t):void 0}},this.connected=!1,this.socket.onclose=function(t){return e.setState("disconnected",t),"Closed"===t||"Stopped by server"===t?e.setState("stopped",e.lastError||t):void 0},this.socket.onerror=function(t){return e.emit("error",t)},this.socket.onopen=function(){return e.setState("connecting")},this.reset()}return t.prototype._error=function(t){return this.setState("stopped",t),this.disconnect(t)},t.prototype.reset=function(){return this.id=this.lastError=this.lastReceivedDoc=this.lastSentDoc=null,this.seq=1},t.prototype.setState=function(t,e){var n,o,i,r,s,a;if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state||"connected"===t&&"connecting"!==this.state)throw Error("Cannot transition directly from "+this.state+" to "+t);this.state=t,this.canSend="connecting"===t||"connected"===t,"disconnected"===t&&this.reset(),this.emit(t,e),s=this.collections,a=[];for(n in s)o=s[n],a.push(function(){var n;n=[];for(r in o)i=o[r],n.push(i._connectionStateChanged(t,e));return n}());return a}},t.prototype.send=function(t){var e,n;return console.log("SEND:",t),t.doc&&(n=t.doc,e=t.c,e===this.lastSentCollection&&n===this.lastSentDoc?(delete t.c,delete t.doc):(this.lastSentCollection=e,this.lastSentDoc=n)),this.socket.send(t)},t.prototype.disconnect=function(){return this.socket.close()},t.prototype.get=function(t,e){var n;return null!=(n=this.collections[t])?n[e]:void 0},t.prototype.getOrCreate=function(t,e,n){var o,i;return(o=this.get(t,e))?o:(o=new r(this,t,e,n),t=(i=this.collections)[t]||(i[t]={}),t[e]=o)},t.prototype.query=function(t,e,n){var o;return o=new Query(this,this.nextQueryId++,t,e),o.autoFetch=n,o.once,o},t}(),"undefined"==typeof window&&(n=require("./microevent")),n.mixin(a),e.Connection=a;var h;h=function(t,e,n){var o,i;if(e!==n){for(i=0;e.charAt(i)===n.charAt(i);)i++;for(o=0;e.charAt(e.length-1-o)===n.charAt(n.length-1-o)&&e.length>o+i&&n.length>o+i;)o++;return e.length!==i+o&&t.remove(i,e.length-i-o),n.length!==i+o?t.insert(i,n.slice(i,n.length-o)):void 0}},window.sharejs.Doc.prototype.attach_textarea=function(t){var e,n,o,i,r,s,a;return n=null,a=function(e,n){var o,i;return o=[n(t.selectionStart),n(t.selectionEnd)],i=t.scrollTop,t.value=e,t.scrollTop!==i&&(t.scrollTop=i),window.document.activeElement===t?(t.selectionStart=o[0],t.selectionEnd=o[1],o):void 0},r=function(e,n){var o,i;return i=function(t){return t>e?t+n.length:t},o=t.value.replace(/\r\n/g,"\n"),a(o.slice(0,e)+n+o.slice(e),i)},s=function(e,n){var o,i;return i=function(t){return t>e?t-Math.min(n,t-e):t},o=t.value.replace(/\r\n/g,"\n"),a(o.slice(0,e)+o.slice(e+n),i)},i=function(){var e;return e=function(t){return setTimeout(t,0)},e(function(){var e;return t.value!==e?(e=t.value,h(n,n.getText(),t.value.replace(/\r\n/g,"\n"))):void 0})},e=function(){var e,a,c,h,p;if(!doc.provides.text)return"undefined"!=typeof console&&null!==console?console.warn("Could not attach document: text api incompatible"):void 0;for(n=doc.createEditingContext(),a=t.value=n.getText(),n.onInsert=r,n.onRemove=s,p=["textInput","keydown","keyup","select","cut","paste"],c=0,h=p.length;h>c;c++)e=p[c],t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent("on"+e,i);return doc.once("deleted",o)},o=t.detach_share=function(){var o,r,s,a;for(n.onInsert=n.onRemove=null,a=["textInput","keydown","keyup","select","cut","paste"],r=0,s=a.length;s>r;r++)o=a[r],t.removeEventListener?t.removeEventListener(o,i,!1):t.detachEvent("on"+o,i);return doc.once("ready",e)},doc.type?e():doc.once("ready",e)}})();