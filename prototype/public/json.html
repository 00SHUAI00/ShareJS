<script src="channel/bcsocket.js"></script>
<script src="share.uncompressed.js"></script>
<script>

var s = new BCSocket(null, {reconnect: true});

var sjs = new window.sharejs.Connection(s);

var doc = sjs.getOrCreate('json_test', 'test_doc_1');

console.log(doc);

doc.subscribe();

doc.whenReady(function () {
  console.log('fooo');
  console.log(doc);
  if (!doc.type) doc.create('json0');
  if (doc.type && doc.type.name === 'json0'){
    context = doc.createContext();
    subDoc = context.at([]);
    clientExample(subDoc);
  }
});


function clientExample(doc){

  console.log(
    'JSON Client API',
    'https://github.com/share/ShareJS/wiki/JSON-Client-API');

  console.log('json client',doc);
  // Create some JSON object
  var myObject = { todo: [] };

  // Set the structure of the document to the JSON object
  doc.set( myObject, function(){


  // Get the document's JSON object
  docObject = doc.get(); // => {'todo':[]}
  console.log('snapshot',docObject);

  // Get the "todo" subdoc
  todo = doc.at(['todo']);
  console.log('todo',todo);

  // print out the "todo" subdoc
  console.log( todo.get() ); // => []

  // Push a value to the "todo" subdoc
  todo.push('take out the garbage');

  // Print out the "todo" subdoc again
  console.log( todo.get() ); // => ['take out the garbage']

  // Set the "todo" subdoc to a completely different value
  todo.set('some string value');

  // Print out the "todo" subdoc again
  console.log( todo.get() ); // => 'some string value'

  // Get the document JSON object again
  doc.get(); // => {'todo':'some string value'}

  // Create event when something is inserted into the doc
  todo.on('insert', function (pos, item) {
    // ...
  });

  todo.on('child op', function (path, op) {
    var item_idx = path[0]
    console.log("Item "+item_idx+" now reads "+todo.get()[item_idx])
    if (op.si != undefined) {
      // ...
    } else if (op.sd != undefined) {
      // ...
    }
  })

  });
}

</script>

<p>JSON Client API example (check it out in the console)</p>
